<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»å¯¹å¯¹é½ç»ˆæç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* === åŸºç¡€è®¾ç½® === */
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { 
            background: #f0f2f5; 
            font-family: -apple-system, sans-serif; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; padding-bottom: 90px;
            overflow-x: hidden;
        }

        /* === A4 çº¸å¼ å®¹å™¨ === */
        .paper-container {
            background: white; 
            width: 95vw; max-width: 500px; aspect-ratio: 210/297; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            border-radius: 4px;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            gap: 40px; padding: 0;
            position: relative;
        }

        /* === æ‰«æå¡æ§½ (ç»å¯¹å±…ä¸­) === */
        .scan-slot {
            width: 85.6mm; height: 54mm; 
            max-width: 85%; aspect-ratio: 85.6/54; 
            border: 2px dashed #9ca3af; 
            background-color: #f8fafc; 
            border-radius: 8px; 
            position: relative; 
            overflow: hidden; 
            cursor: pointer; 
            display: flex; justify-content: center; align-items: center;
        }

        /* å›¾ç‰‡å¼ºåˆ¶ç»å¯¹å±…ä¸­ï¼Œç¡®ä¿ä¸åå·¦ */
        .scan-slot img { 
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            width: 100%; height: 100%; 
            object-fit: fill; 
            display: none; z-index: 10;
        }

        .slot-placeholder { text-align: center; color: #94a3b8; pointer-events: none; z-index: 1; }
        .slot-placeholder h3 { font-size: 16px; margin-bottom: 5px; color: #475569; }

        /* === åº•éƒ¨ä¸»æŒ‰é’® === */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: white; padding: 15px 20px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05); 
            display: flex; gap: 15px; z-index: 100;
        }
        .btn { flex: 1; height: 50px; border-radius: 25px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-main { background: #2563eb; color: white; }
        .btn-sec { background: #f1f5f9; color: #334155; }

        /* === å…¨å± Canvas ç›¸æœº === */
        .camera-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; 
            display: none; 
        }

        /* æ ¸å¿ƒï¼šç”¨ Canvas ä»£æ›¿ Video æ ‡ç­¾è¿›è¡Œæ¸²æŸ“ */
        canvas#camera-canvas {
            display: block; width: 100%; height: 100%;
        }

        /* éšè—çš„ video æ ‡ç­¾ï¼Œåªç”¨äºè·å–æ•°æ®æµ */
        #hidden-video {
            display: none;
            position: absolute; top: 0; left: 0;
        }

        /* ç•Œé¢æ§ä»¶å±‚ */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ */
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            padding: 40px 0;
            z-index: 20;
        }

        .top-tip {
            color: white; background: rgba(0,0,0,0.5); 
            padding: 8px 16px; border-radius: 20px; font-size: 14px;
            text-shadow: 0 1px 2px black;
        }

        .controls-area {
            width: 100%; pointer-events: auto; /* æ¢å¤ç‚¹å‡» */
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            padding-bottom: 20px;
        }

        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .mode-btn {
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.5);
            color: #4ade80; padding: 8px 20px; border-radius: 20px; 
            font-size: 14px; cursor: pointer; backdrop-filter: blur(4px);
        }

        .shutter-row {
            display: flex; width: 100%; justify-content: space-around; align-items: center;
        }

        .shutter-btn { 
            width: 80px; height: 80px; background: white; border-radius: 50%; 
            border: 6px solid rgba(220,220,220,0.5); cursor: pointer; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .shutter-btn:active { transform: scale(0.95); background: #eee; }

        .circle-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255,255,255,0.2); backdrop-filter: blur(4px);
            border: none; color: white; font-size: 12px;
            display: flex; align-items: center; justify-content: center;
            text-align: center; cursor: pointer;
        }

        .generating .scan-slot { border: none; background: white; }
        .generating .slot-placeholder { display: none; }
    </style>
</head>
<body>

    <div class="paper-container" id="pdf-area">
        <div class="scan-slot" onclick="startCamera('front')">
            <div class="slot-placeholder" id="ph-front"><h3>+ èº«ä»½è¯äººåƒé¢</h3><p>ç‚¹å‡»æ‹æ‘„</p></div>
            <img id="img-front">
        </div>
        <div class="scan-slot" onclick="startCamera('back')">
            <div class="slot-placeholder" id="ph-back"><h3>+ èº«ä»½è¯å›½å¾½é¢</h3><p>ç‚¹å‡»æ‹æ‘„</p></div>
            <img id="img-back">
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn btn-sec" onclick="location.reload()">æ¸…ç©º</button>
        <button class="btn btn-main" onclick="makePDF()">ç”Ÿæˆ PDF</button>
    </div>

    <div class="camera-overlay" id="cam-modal">
        <video id="hidden-video" autoplay playsinline muted></video>
        
        <canvas id="camera-canvas"></canvas>

        <div class="ui-layer">
            <div class="top-tip">è¯·å°†è¯ä»¶<b>å¡«æ»¡</b>ç»¿è‰²æ¡†</div>
            
            <div class="controls-area">
                <button class="mode-btn" id="color-btn" onclick="toggleColor()">
                    ğŸ¨ æ¨¡å¼ï¼šå½©è‰²åŸå›¾
                </button>

                <div class="shutter-row">
                    <button class="circle-btn" onclick="closeCamera()">å–æ¶ˆ</button>
                    <button class="shutter-btn" onclick="takePhoto()"></button>
                    <button class="circle-btn" onclick="switchCamera()">åˆ‡æ¢<br>é•œå¤´</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === çŠ¶æ€ç®¡ç† ===
        let stream = null;
        let animationId = null;
        let currentSide = '';
        let isColor = true; // é»˜è®¤å½©è‰²
        let devices = [];
        let devIdx = 0;

        // DOM å…ƒç´ 
        const video = document.getElementById('hidden-video');
        const canvas = document.getElementById('camera-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const modal = document.getElementById('cam-modal');
        const colorBtn = document.getElementById('color-btn');

        // 1. é¢œè‰²åˆ‡æ¢
        function toggleColor() {
            isColor = !isColor;
            if (isColor) {
                colorBtn.innerText = "ğŸ¨ æ¨¡å¼ï¼šå½©è‰²åŸå›¾";
                colorBtn.style.color = "#4ade80";
                colorBtn.style.borderColor = "rgba(255,255,255,0.5)";
            } else {
                colorBtn.innerText = "ğŸ“„ æ¨¡å¼ï¼šé»‘ç™½å¤å°";
                colorBtn.style.color = "white";
                colorBtn.style.borderColor = "white";
            }
        }

        // 2. å¯åŠ¨ç›¸æœº
        async function startCamera(side) {
            currentSide = side;
            modal.style.display = 'block';
            
            // è®¾ç½®ç”»å¸ƒå°ºå¯¸ä¸ºå…¨å±
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            // ä¼˜å…ˆåç½®
            try {
                await startStream({ video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } });
            } catch (e) {
                await startStream({ video: true }); // é™çº§
            }
            
            await listDevices();
            drawLoop(); // å¼€å§‹ç”»å¸ƒæ¸²æŸ“å¾ªç¯
        }

        async function startStream(constraints) {
            if (stream) stream.getTracks().forEach(t => t.stop());
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: false, ...constraints });
                video.srcObject = stream;
                await video.play();
            } catch (e) {
                alert("æ— æ³•å¯åŠ¨ç›¸æœº: " + e.message);
            }
        }

        async function listDevices() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return;
            const devs = await navigator.mediaDevices.enumerateDevices();
            devices = devs.filter(d => d.kind === 'videoinput');
        }

        async function switchCamera() {
            if (devices.length < 2) { await listDevices(); if(devices.length<2) return; }
            devIdx = (devIdx + 1) % devices.length;
            await startStream({ video: { deviceId: { exact: devices[devIdx].deviceId } } });
        }

        // 3. æ ¸å¿ƒï¼šç”»å¸ƒæ¸²æŸ“å¾ªç¯ (The Magic)
        // è¿™ä¸ªå‡½æ•°æ¯ç§’è¿è¡Œ60æ¬¡ï¼Œè´Ÿè´£æŠŠè§†é¢‘ç”»åˆ°å±å¹•ä¸Šï¼Œå¹¶ç”»ä¸Šç»¿æ¡†
        function drawLoop() {
            if (modal.style.display === 'none') return;
            
            // A. æ¸…ç©ºç”»å¸ƒ
            const cW = canvas.width;
            const cH = canvas.height;
            ctx.clearRect(0, 0, cW, cH);

            // B. ç»˜åˆ¶è§†é¢‘ (æ¨¡æ‹Ÿ object-fit: cover)
            const vW = video.videoWidth;
            const vH = video.videoHeight;
            
            if (vW && vH) {
                // è®¡ç®—å¡«å……æ¯”ä¾‹
                const scale = Math.max(cW / vW, cH / vH);
                const drawW = vW * scale;
                const drawH = vH * scale;
                // å±…ä¸­åç§»
                const offsetX = (cW - drawW) / 2;
                const offsetY = (cH - drawH) / 2;
                
                // å°†è§†é¢‘ç”»åˆ°åº•å±‚
                ctx.drawImage(video, offsetX, offsetY, drawW, drawH);
            }

            // C. ç»˜åˆ¶é®ç½©å±‚ (åŠé€æ˜é»‘)
            ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
            ctx.fillRect(0, 0, cW, cH);

            // D. ç»˜åˆ¶â€œæŒ–ç©ºâ€åŒºåŸŸ (ç»¿æ¡†åŒºåŸŸ)
            // è®¡ç®—ç»¿æ¡†å°ºå¯¸ï¼šå®½=å±å¹•85%ï¼Œé«˜=å®½/1.585
            const boxW = cW * 0.85;
            const boxH = boxW / 1.585;
            const boxX = (cW - boxW) / 2;
            const boxY = (cH - boxH) / 2 - 50; // ç¨å¾®é ä¸Š

            // ä½¿ç”¨ clearRect "æŒ–"å‡ºä¸€ä¸ªæ´ï¼Œè®©åº•ä¸‹çš„è§†é¢‘éœ²å‡ºæ¥
            ctx.clearRect(boxX, boxY, boxW, boxH);
            // è¿™é‡Œå¿…é¡»é‡æ–°ç”»ä¸€æ¬¡è§†é¢‘åœ¨æ´é‡Œï¼Œå› ä¸ºåˆšæ‰fillRectç›–ä½äº†
            // (è™½ç„¶æ€§èƒ½æŸè€—ä¸€ç‚¹ï¼Œä½†è¿™æ˜¯å®ç°æŒ–ç©ºæœ€ç®€å•çš„é€»è¾‘å…¼å®¹æ€§æœ€å¥½)
            ctx.save();
            ctx.beginPath();
            ctx.rect(boxX, boxY, boxW, boxH);
            ctx.clip();
            // é‡æ–°ç»˜åˆ¶è§†é¢‘åœ¨è£å‰ªåŒº
            if (vW && vH) {
                const scale = Math.max(cW / vW, cH / vH);
                const drawW = vW * scale;
                const drawH = vH * scale;
                const offsetX = (cW - drawW) / 2;
                const offsetY = (cH - drawH) / 2;
                ctx.drawImage(video, offsetX, offsetY, drawW, drawH);
            }
            ctx.restore();

            // E. ç»˜åˆ¶ç»¿æ¡†è¾¹æ¡†
            ctx.strokeStyle = "#00ff00";
            ctx.lineWidth = 3;
            ctx.strokeRect(boxX, boxY, boxW, boxH);

            animationId = requestAnimationFrame(drawLoop);
        }

        // 4. æ‹ç…§ (WYSIWYG: æ‰€è§å³æ‰€å¾—)
        function takePhoto() {
            // åœæ­¢æ¸²æŸ“å¾ªç¯ï¼Œå®šæ ¼ç”»é¢
            cancelAnimationFrame(animationId);

            // è®¡ç®—ç»¿æ¡†ä½ç½®
            const cW = canvas.width;
            const cH = canvas.height;
            const boxW = cW * 0.85;
            const boxH = boxW / 1.585;
            const boxX = (cW - boxW) / 2;
            const boxY = (cH - boxH) / 2 - 50;

            // 1. åˆ›å»ºä¸´æ—¶ç”»å¸ƒï¼Œåªç»˜åˆ¶çº¯å‡€çš„è§†é¢‘
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = cW;
            tempCanvas.height = cH;
            const tCtx = tempCanvas.getContext('2d');
            
            // é‡æ–°è®¡ç®—è§†é¢‘ä½ç½®
            const vW = video.videoWidth;
            const vH = video.videoHeight;
            const scale = Math.max(cW / vW, cH / vH);
            const drawW = vW * scale;
            const drawH = vH * scale;
            const offsetX = (cW - drawW) / 2;
            const offsetY = (cH - drawH) / 2;
            
            // ç»˜åˆ¶çº¯è§†é¢‘åˆ°ä¸´æ—¶ç”»å¸ƒ (æ²¡æœ‰é»‘æ¡†é®ç½©)
            tCtx.drawImage(video, offsetX, offsetY, drawW, drawH);

            // 2. ä»ä¸´æ—¶ç”»å¸ƒä¸­æå–ç»¿æ¡†åŒºåŸŸ
            // è¿™ä¸€æ­¥ä¿è¯äº†ï¼šä½ åˆšæ‰çœ‹åˆ°çš„ç»¿æ¡†é‡Œæ˜¯ä»€ä¹ˆï¼Œæå–å‡ºæ¥çš„å°±æ˜¯ä»€ä¹ˆ
            const cropData = tCtx.getImageData(boxX, boxY, boxW, boxH);

            // 3. æ”¾åˆ°æœ€ç»ˆç»“æœç”»å¸ƒä¸Š
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = boxW;
            finalCanvas.height = boxH;
            const fCtx = finalCanvas.getContext('2d');
            fCtx.putImageData(cropData, 0, 0);

            // 4. é»‘ç™½å¤„ç† (å¦‚æœéœ€è¦)
            if (!isColor) {
                const imgData = fCtx.getImageData(0, 0, finalCanvas.width, finalCanvas.height);
                const data = imgData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    const val = gray > 110 ? 255 : gray * 0.7;
                    data[i] = data[i+1] = data[i+2] = val;
                }
                fCtx.putImageData(imgData, 0, 0);
            }

            // 5. æ˜¾ç¤ºç»“æœ
            const img = document.getElementById('img-' + currentSide);
            const ph = document.getElementById('ph-' + currentSide);
            img.src = finalCanvas.toDataURL('image/jpeg', 0.95);
            img.style.display = 'block';
            ph.style.display = 'none';

            closeCamera();
        }

        function closeCamera() {
            modal.style.display = 'none';
            cancelAnimationFrame(animationId);
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
        }

        // PDF ç”Ÿæˆ
        function makePDF() {
            const el = document.getElementById('pdf-area');
            if (!document.getElementById('img-front').src) { return alert("è¯·å…ˆæ‹æ‘„"); }
            el.classList.add('generating');
            html2pdf().set({ 
                margin: 0, 
                filename: 'èº«ä»½è¯å¤å°ä»¶.pdf', 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            }).from(el).save().then(() => el.classList.remove('generating'));
        }
    </script>
</body>
</html>
