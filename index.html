<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¯ä»¶æ‰«æç»ˆæå®Œç¾ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* === 1. å…¨å±€é‡ç½®ä¸åŸºç¡€å¸ƒå±€ === */
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { 
            background: #f0f2f5; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; padding-bottom: 100px; /* ç•™å‡ºåº•éƒ¨æŒ‰é’®ç©ºé—´ */
        }

        /* === 2. A4 çº¸å¼ å®¹å™¨ (æ ¸å¿ƒé¢„è§ˆåŒº) === */
        .paper-container {
            background: white; 
            width: 95vw; max-width: 500px; aspect-ratio: 210/297; /* é”å®š A4 æ¯”ä¾‹ */
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
            border-radius: 4px;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            gap: 50px; /* æ­£åé¢é—´è· */
            padding: 0;
            position: relative;
        }

        /* === 3. æ‰«æå¡æ§½ (ç»å¯¹å±…ä¸­ä¿®å¤) === */
        .scan-slot {
            width: 85.6mm; height: 54mm; /* èº«ä»½è¯ç‰©ç†å°ºå¯¸ */
            max-width: 85%; /* é˜²æ­¢å°å±å¹•æº¢å‡º */
            aspect-ratio: 85.6/54; 
            border: 2px dashed #cbd5e1; 
            background-color: #f8fafc; 
            border-radius: 8px; 
            position: relative; /* ä½œä¸ºç»å¯¹å®šä½çš„é”šç‚¹ */
            overflow: hidden; 
            cursor: pointer; 
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s;
        }
        .scan-slot:active { background-color: #e2e8f0; }

        /* å›¾ç‰‡æ ·å¼ï¼šå¼ºåˆ¶ç»å¯¹å±…ä¸­ï¼Œæ— è§†ä»»ä½• Padding å¹²æ‰° */
        .scan-slot img { 
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); /* å‡ ä½•ä¸­å¿ƒå¯¹é½ */
            width: 100%; height: 100%; 
            object-fit: fill; /* å¼ºåˆ¶æ‹‰ä¼¸å¡«æ»¡è£å‰ªåŒºåŸŸ */
            display: none; 
            z-index: 10;
        }

        /* å ä½æ–‡å­— */
        .slot-placeholder { text-align: center; color: #94a3b8; pointer-events: none; z-index: 1; }
        .slot-placeholder h3 { font-size: 16px; margin-bottom: 6px; color: #475569; font-weight: 600; }
        .slot-placeholder p { font-size: 12px; }
        .icon-camera { font-size: 24px; display: block; margin-bottom: 5px; }

        /* === 4. åº•éƒ¨ä¸»æ“ä½œæ  === */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08); 
            display: flex; gap: 15px; z-index: 100;
        }
        .btn { 
            flex: 1; height: 52px; border-radius: 26px; border: none; 
            font-size: 16px; font-weight: 600; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
        }
        .btn-main { background: #2563eb; color: white; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
        .btn-sec { background: #f1f5f9; color: #334155; }
        .btn:active { transform: scale(0.98); }

        /* === 5. å…¨å±ç›¸æœºé®ç½© (å±‚çº§æœ€é«˜) === */
        .camera-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; 
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column; justify-content: center; align-items: center;
        }

        /* è§†é¢‘å±‚ï¼šä¿æŒ cover æ¨¡å¼ */
        video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; 
        }

        /* é®ç½© SVG */
        .mask-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        /* é¡¶éƒ¨æç¤ºä¸å¼€å…³ */
        .top-controls {
            position: absolute; top: 0; left: 0; width: 100%;
            padding-top: 50px; /* é¿å¼€åˆ˜æµ·å± */
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            z-index: 50;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°ä¸‹é¢ */
        }

        .guide-text { 
            color: white; font-size: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); 
            background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 12px;
        }

        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® (å¯ç‚¹å‡») */
        .mode-toggle {
            pointer-events: auto; /* æ¢å¤ç‚¹å‡» */
            background: rgba(0,0,0,0.6); 
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff; padding: 8px 24px; border-radius: 20px; font-size: 14px;
            cursor: pointer; backdrop-filter: blur(5px);
            display: flex; align-items: center; gap: 6px;
            transition: all 0.3s;
        }
        /* å½©è‰²æ¿€æ´»çŠ¶æ€ */
        .mode-toggle.color-active { border-color: #4ade80; color: #4ade80; background: rgba(0,50,0,0.6); }

        /* åº•éƒ¨æ‹ç…§æ“ä½œåŒº */
        .cam-actions {
            position: absolute; bottom: 40px; width: 100%;
            display: flex; justify-content: space-around; align-items: center; z-index: 50;
        }

        .shutter-btn { 
            width: 76px; height: 76px; background: white; border-radius: 50%; 
            border: 5px solid rgba(220,220,220,0.5); cursor: pointer; 
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .shutter-btn:active { transform: scale(0.9); background: #f0f0f0; }

        .circle-btn {
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(255,255,255,0.2); backdrop-filter: blur(5px);
            border: none; color: white; font-size: 12px;
            display: flex; align-items: center; justify-content: center;
        }

        /* ç”Ÿæˆ PDF æ—¶çš„æ ·å¼ä¿®æ­£ */
        .generating .scan-slot { border: none; background: white; }
        .generating .slot-placeholder { display: none; }
    </style>
</head>
<body>

    <div class="paper-container" id="pdf-area">
        <div class="scan-slot" onclick="openCamera('front')">
            <div class="slot-placeholder" id="ph-front">
                <span class="icon-camera">ğŸ“·</span>
                <h3>æ‹æ‘„äººåƒé¢</h3>
                <p>ç‚¹å‡»å¼€å¯ç›¸æœº</p>
            </div>
            <img id="img-front">
        </div>

        <div class="scan-slot" onclick="openCamera('back')">
            <div class="slot-placeholder" id="ph-back">
                <span class="icon-camera">ğŸ“·</span>
                <h3>æ‹æ‘„å›½å¾½é¢</h3>
                <p>ç‚¹å‡»å¼€å¯ç›¸æœº</p>
            </div>
            <img id="img-back">
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn btn-sec" onclick="location.reload()">æ¸…ç©ºé‡ç½®</button>
        <button class="btn btn-main" onclick="makePDF()">ç”Ÿæˆ PDF</button>
    </div>

    <div class="camera-overlay" id="cam-modal">
        <video id="video" autoplay playsinline muted></video>
        
        <svg class="mask-svg" width="100%" height="100%">
            <defs>
                <mask id="mask-layer">
                    <rect x="0" y="0" width="100%" height="100%" fill="white" />
                    <rect id="cutout-rect" fill="black" rx="10" ry="10" />
                </mask>
            </defs>
            <rect x="0" y="0" width="100%" height="100%" fill="rgba(0,0,0,0.85)" mask="url(#mask-layer)" />
            <rect id="border-rect" fill="transparent" stroke="#00ff00" stroke-width="2" rx="10" ry="10" />
        </svg>

        <div class="top-controls">
            <div class="guide-text">è¯·å°†è¯ä»¶<b>å±…ä¸­å¡«æ»¡</b>ç»¿æ¡†</div>
            
            <button class="mode-toggle color-active" id="color-btn" onclick="toggleColor()">
                ğŸ¨ æ¨¡å¼ï¼šå½©è‰²åŸå›¾
            </button>
        </div>

        <div class="cam-actions">
            <button class="circle-btn" onclick="closeCam()">å–æ¶ˆ</button>
            <button class="shutter-btn" onclick="takePhoto()"></button>
            <button class="circle-btn" onclick="cycleCamera()">åˆ‡æ¢<br>é•œå¤´</button>
        </div>
    </div>

    <script>
        // === 1. çŠ¶æ€å˜é‡ ===
        let stream = null;
        let currentSide = '';
        let devices = [];
        let devIdx = 0;
        let isColor = true; // é»˜è®¤å½©è‰²ï¼Œè§£å†³å®‰å“é—®é¢˜

        // DOM å…ƒç´ 
        const video = document.getElementById('video');
        const modal = document.getElementById('cam-modal');
        const cutout = document.getElementById('cutout-rect');
        const border = document.getElementById('border-rect');
        const colorBtn = document.getElementById('color-btn');

        // === 2. ç•Œé¢é€»è¾‘ ===

        // åˆ‡æ¢é¢œè‰²æ¨¡å¼
        function toggleColor() {
            isColor = !isColor;
            if (isColor) {
                colorBtn.innerHTML = "ğŸ¨ æ¨¡å¼ï¼šå½©è‰²åŸå›¾";
                colorBtn.classList.add('color-active');
            } else {
                colorBtn.innerHTML = "ğŸ“„ æ¨¡å¼ï¼šé»‘ç™½å¤å°";
                colorBtn.classList.remove('color-active');
            }
        }

        // è®¡ç®—é®ç½©ä½ç½® (å§‹ç»ˆå±å¹•å±…ä¸­)
        function updateMask() {
            const sW = window.innerWidth;
            const sH = window.innerHeight;
            // æ‰«ææ¡†å®½åº¦è®¾ä¸ºå±å¹•çš„ 85%
            const w = sW * 0.85; 
            // èº«ä»½è¯æ¯”ä¾‹ 85.6 : 54 = 1.585
            const h = w / 1.585; 
            
            // å±…ä¸­è®¡ç®—
            const x = (sW - w) / 2;
            const y = (sH - h) / 2 - 40; // ç¨å¾®åä¸Šä¸€ç‚¹ï¼Œç¬¦åˆè§†è§‰é‡å¿ƒ
            
            // æ›´æ–° SVG
            cutout.setAttribute('x', x); cutout.setAttribute('y', y);
            cutout.setAttribute('width', w); cutout.setAttribute('height', h);
            border.setAttribute('x', x); border.setAttribute('y', y);
            border.setAttribute('width', w); border.setAttribute('height', h);
            
            return { w, h };
        }

        // === 3. ç›¸æœºæ ¸å¿ƒé€»è¾‘ ===

        // æ‰“å¼€ç›¸æœº
        async function openCamera(side) {
            currentSide = side;
            updateMask();
            modal.style.display = 'flex';
            
            // ä¼˜å…ˆè¯·æ±‚åç½®ç¯å¢ƒé•œå¤´
            try {
                await startStream({ 
                    video: { 
                        facingMode: "environment", 
                        width: { ideal: 1920 }, 
                        height: { ideal: 1080 } 
                    } 
                });
            } catch (e) {
                // é™çº§å°è¯•
                await startStream({ video: true });
            }
            
            // è·å–è®¾å¤‡åˆ—è¡¨ç”¨äºåˆ‡æ¢
            await listDevices();
        }

        // å¯åŠ¨æµ
        async function startStream(constraints) {
            if (stream) stream.getTracks().forEach(t => t.stop());
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: false, ...constraints });
                video.srcObject = stream;
                // å¼ºåˆ¶æ’­æ”¾ï¼Œé˜²æ­¢ iOS å†»ç»“
                await video.play();
            } catch (e) {
                alert("ç›¸æœºå¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™æˆ–HTTPSè®¾ç½®ã€‚");
                console.error(e);
            }
        }

        // è·å–æ‘„åƒå¤´åˆ—è¡¨
        async function listDevices() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return;
                const devs = await navigator.mediaDevices.enumerateDevices();
                devices = devs.filter(d => d.kind === 'videoinput');
            } catch(e) { console.error(e); }
        }

        // åˆ‡æ¢é•œå¤´ (æš´åŠ›è½®è¯¢æ³•ï¼Œè§£å†³ iOS é€‰ä¸ä¸­ä¸»æ‘„é—®é¢˜)
        async function cycleCamera() {
            if (devices.length < 2) {
                await listDevices();
                if (devices.length < 2) return alert("åªæœ‰ä¸€ä¸ªæ‘„åƒå¤´");
            }
            devIdx = (devIdx + 1) % devices.length;
            // ä½¿ç”¨ exact deviceId å¼ºåˆ¶åˆ‡æ¢
            await startStream({ video: { deviceId: { exact: devices[devIdx].deviceId } } });
        }

        // === 4. æ‹ç…§ä¸è£å‰ª (æ ¸å¿ƒç®—æ³•ä¿®å¤) ===
        function takePhoto() {
            if (!stream) return;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // 1. è·å–è§†é¢‘æºå®é™…åˆ†è¾¨ç‡
            const vW = video.videoWidth;
            const vH = video.videoHeight;
            // 2. è·å–å±å¹•è§†å£åˆ†è¾¨ç‡
            const sW = window.innerWidth;
            const sH = window.innerHeight;

            // 3. è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ (object-fit: cover çš„æ•°å­¦åŸç†)
            // æ‰¾å‡ºæ˜¯ä¾å®½åº¦ç¼©æ”¾è¿˜æ˜¯ä¾é«˜åº¦ç¼©æ”¾
            const scale = Math.max(sW / vW, sH / vH);

            // 4. è·å–å±å¹•ä¸Šç»¿æ¡†çš„ç‰©ç†å°ºå¯¸
            const mask = updateMask();

            // 5. åç®—ï¼šç»¿æ¡†å¯¹åº”è§†é¢‘æºä¸­çš„å°ºå¯¸
            const cropW = mask.w / scale;
            const cropH = mask.h / scale;

            // 6. æ ¸å¿ƒï¼šå› ä¸ºç»¿æ¡†å±…ä¸­ï¼Œé•œå¤´å±…ä¸­ï¼Œæ‰€ä»¥ç›´æ¥æˆªå–è§†é¢‘æºä¸­å¿ƒ
            const cropX = (vW - cropW) / 2;
            const cropY = (vH - cropH) / 2;

            // è®¾ç½®ç”»å¸ƒä¸ºé«˜æ¸…å°ºå¯¸
            canvas.width = 1200;
            canvas.height = 1200 / 1.585;

            // ç»˜åˆ¶è£å‰ªå›¾
            ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, canvas.width, canvas.height);

            // å¦‚æœä¸æ˜¯å½©è‰²ï¼Œåº”ç”¨é»‘ç™½æ»¤é•œ
            if (!isColor) {
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imgData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    // å¼ºå¯¹æ¯”åº¦é˜ˆå€¼å¤„ç†
                    const val = gray > 110 ? 255 : gray * 0.7;
                    data[i] = data[i+1] = data[i+2] = val;
                }
                ctx.putImageData(imgData, 0, 0);
            }

            // æ˜¾ç¤ºå›¾ç‰‡
            const img = document.getElementById('img-' + currentSide);
            const ph = document.getElementById('ph-' + currentSide);
            
            img.src = canvas.toDataURL('image/jpeg', 0.95);
            img.style.display = 'block'; // é…åˆCSSçš„ç»å¯¹å±…ä¸­
            ph.style.display = 'none';
            
            closeCam();
        }

        function closeCam() {
            modal.style.display = 'none';
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
        }

        // === 5. PDF ç”Ÿæˆ ===
        function makePDF() {
            const el = document.getElementById('pdf-area');
            // æ£€æŸ¥æ˜¯å¦æœ‰å›¾
            if (!document.getElementById('img-front').src && !document.getElementById('img-back').src) {
                return alert("è¯·è‡³å°‘æ‹æ‘„ä¸€å¼ ç…§ç‰‡");
            }

            el.classList.add('generating'); // éšè—è¾¹æ¡†
            
            const opt = {
                margin: 0,
                filename: 'èº«ä»½è¯æ‰«æä»¶.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(el).save()
                .then(() => el.classList.remove('generating'))
                .catch(err => {
                    console.error(err);
                    alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•");
                    el.classList.remove('generating');
                });
        }
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç»˜é®ç½©
        window.onresize = updateMask;
    </script>
</body>
</html>
