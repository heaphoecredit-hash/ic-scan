<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>证件扫描王 (Web版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            margin: 0; padding: 0;
            background-color: #000; /* 沉浸式黑色背景 */
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden; /* 禁止滚动，像原生App */
            height: 100vh;
            display: flex; flex-direction: column;
        }

        /* --- 1. 顶部状态栏 --- */
        .top-bar {
            height: 60px;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.5);
            position: absolute; top: 0; width: 100%; z-index: 20;
        }
        .top-title { font-size: 16px; font-weight: 600; letter-spacing: 1px; }

        /* --- 2. 核心：实时相机取景器 --- */
        .camera-view {
            position: relative;
            flex: 1; /* 占满剩余空间 */
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            background: #000;
        }

        video {
            /* 视频流铺满，保持比例 */
            width: 100%; height: 100%; object-fit: cover;
        }

        /* --- 3. 仿扫描全能王的绿色对准框 --- */
        .scan-frame {
            position: absolute;
            width: 85%;
            /* 身份证比例 1.58:1 */
            aspect-ratio: 1.58 / 1;
            border: 2px solid #00ffcc; /* 扫描仪标志性的青绿色 */
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.6); /* 压暗周围 */
            border-radius: 8px;
            z-index: 10;
        }

        /* 四角装饰 */
        .corner {
            position: absolute; width: 20px; height: 20px;
            border-color: #00ffcc; border-style: solid;
        }
        .tl { top: -2px; left: -2px; border-width: 4px 0 0 4px; }
        .tr { top: -2px; right: -2px; border-width: 4px 4px 0 0; }
        .bl { bottom: -2px; left: -2px; border-width: 0 0 4px 4px; }
        .br { bottom: -2px; right: -2px; border-width: 0 4px 4px 0; }

        /* 扫描线动画 */
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: #00ffcc;
            box-shadow: 0 0 10px #00ffcc;
            animation: scanMove 2s infinite linear;
        }
        @keyframes scanMove {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .guide-text {
            position: absolute; bottom: -40px; width: 100%; text-align: center;
            color: #fff; font-size: 14px; text-shadow: 1px 1px 2px #000;
        }

        /* --- 4. 底部控制栏 --- */
        .controls {
            height: 140px;
            background: #111;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding-bottom: 20px;
            z-index: 20;
        }

        /* 拍照按钮 */
        .shutter-btn {
            width: 70px; height: 70px;
            background: #fff; border-radius: 50%;
            border: 6px solid rgba(255,255,255,0.2);
            position: relative;
        }
        .shutter-btn:active { transform: scale(0.95); background: #ddd; }
        
        /* 步骤指示器 */
        .steps {
            display: flex; gap: 20px; margin-bottom: 15px;
        }
        .step-dot {
            padding: 5px 15px; border-radius: 20px; font-size: 12px; color: #888; background: #222;
        }
        .step-dot.active {
            color: #000; background: #00ffcc; font-weight: bold;
        }

        /* 结果预览弹窗 */
        .preview-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 50;
            display: none; flex-direction: column;
            padding: 20px;
        }
        .preview-list { flex: 1; overflow-y: auto; margin-top: 20px; }
        .scan-item { margin-bottom: 20px; text-align: center; }
        .scan-item img {
            width: 80%; border: 1px solid #333; border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .btn-group { margin-top: 20px; display: flex; gap: 10px; }
        .btn {
            flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold;
        }
        .btn-green { background: #00ffcc; color: #000; }
        .btn-gray { background: #333; color: #fff; }

        /* 错误提示层 */
        #error-msg {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,0,0,0.8); color: white; padding: 20px;
            border-radius: 10px; display: none; z-index: 100; text-align: center;
        }

    </style>
</head>
<body>

    <div class="top-bar">
        <div class="top-title">智能证件扫描</div>
    </div>

    <div class="camera-view">
        <video id="video" autoplay playsinline muted></video>
        
        <div class="scan-frame">
            <div class="corner tl"></div><div class="corner tr"></div>
            <div class="corner bl"></div><div class="corner br"></div>
            <div class="scan-line"></div> <div class="guide-text" id="guide-text">请对准 身份证正面</div>
        </div>
    </div>

    <div class="controls">
        <div class="steps">
            <div class="step-dot active" id="step-1">1. 拍正面</div>
            <div class="step-dot" id="step-2">2. 拍反面</div>
        </div>
        <button class="shutter-btn" onclick="takePhoto()"></button>
    </div>

    <div class="preview-modal" id="preview-layer">
        <h3 style="text-align:center; color:#fff;">扫描完成</h3>
        <div class="preview-list">
            <div class="scan-item">
                <p style="color:#aaa; font-size:12px;">正面 (Front)</p>
                <img id="res-front">
            </div>
            <div class="scan-item">
                <p style="color:#aaa; font-size:12px;">反面 (Back)</p>
                <img id="res-back">
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-gray" onclick="location.reload()">重拍</button>
            <button class="btn btn-green" onclick="downloadPDF()">下载 PDF</button>
        </div>
    </div>

    <div id="error-msg"></div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // 配置
        const state = {
            step: 1, // 1=正面, 2=反面
            frontImg: null,
            backImg: null
        };

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const guideText = document.getElementById('guide-text');
        const errorMsg = document.getElementById('error-msg');

        // --- 1. 启动相机 (修复版) ---
        async function initCamera() {
            try {
                // 强制请求后置摄像头，高清
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // 后置
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });
                video.srcObject = stream;
                // 这里的 play() 在某些iOS上需要用户交互，但有了 autoplay playsinline 通常可以自动
            } catch (err) {
                showError("无法打开相机。<br>请检查：<br>1. 必须使用 HTTPS<br>2. 必须允许摄像头权限<br>错误信息: " + err.name);
            }
        }

        // --- 2. 智能拍照与滤镜处理 ---
        function takePhoto() {
            if (!video.srcObject) return;

            // 设置画布尺寸
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // 绘制当前帧
            ctx.drawImage(video, 0, 0);

            // 【模拟扫描全能王效果】：自动裁切中心区域 + 增加对比度
            const processedImg = processImage(canvas);

            if (state.step === 1) {
                state.frontImg = processedImg;
                // 切换到第二步
                state.step = 2;
                document.getElementById('step-1').classList.remove('active');
                document.getElementById('step-2').classList.add('active');
                guideText.innerText = "请对准 身份证反面";
                
                // 闪屏特效
                flashScreen();
            } else {
                state.backImg = processedImg;
                // 完成，显示结果
                showResult();
            }
        }

        // --- 3. 图像处理核心 (裁切+增强) ---
        function processImage(sourceCanvas) {
            // A. 计算裁切区域 (只取画面中心的 1.58:1 区域)
            const vw = sourceCanvas.width;
            const vh = sourceCanvas.height;
            const targetRatio = 1.58;
            
            let cw, ch, cx, cy;
            // 简单的居中裁切算法
            if (vw / vh > targetRatio) {
                ch = vh * 0.85; // 取高度的85%避免边缘
                cw = ch * targetRatio;
            } else {
                cw = vw * 0.85; // 取宽度的85%
                ch = cw / targetRatio;
            }
            cx = (vw - cw) / 2;
            cy = (vh - ch) / 2;

            // 创建临时画布放裁切后的图
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = cw;
            tempCanvas.height = ch;
            const tCtx = tempCanvas.getContext('2d');

            // 绘制裁切图
            tCtx.drawImage(sourceCanvas, cx, cy, cw, ch, 0, 0, cw, ch);

            // B. 【滤镜】增加对比度，模拟文档扫描
            // 获取像素数据
            const imgData = tCtx.getImageData(0, 0, cw, ch);
            const data = imgData.data;
            
            // 简单的对比度增强算法
            const contrast = 30; // 对比度系数
            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));

            for (let i = 0; i < data.length; i += 4) {
                // R,G,B 通道增强
                data[i] = factor * (data[i] - 128) + 128;
                data[i+1] = factor * (data[i+1] - 128) + 128;
                data[i+2] = factor * (data[i+2] - 128) + 128;
            }
            tCtx.putImageData(imgData, 0, 0);

            return tempCanvas.toDataURL('image/jpeg', 0.9);
        }

        // --- 4. 显示结果 ---
        function showResult() {
            document.getElementById('res-front').src = state.frontImg;
            document.getElementById('res-back').src = state.backImg;
            document.getElementById('preview-layer').style.display = 'flex';
        }

        // --- 5. 生成 PDF ---
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = 210;
            const imgWidth = 180;
            const imgHeight = imgWidth / 1.58;
            const margin = (pageWidth - imgWidth) / 2;

            doc.text("ID Card Scan", 105, 20, {align: 'center'});
            
            doc.text("Front:", margin, 40);
            doc.addImage(state.frontImg, 'JPEG', margin, 45, imgWidth, imgHeight);

            doc.text("Back:", margin, 45 + imgHeight + 20);
            doc.addImage(state.backImg, 'JPEG', margin, 45 + imgHeight + 25, imgWidth, imgHeight);

            doc.save('ID_Scan_Result.pdf');
        }

        function flashScreen() {
            const flash = document.createElement('div');
            flash.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:100;opacity:1;transition:opacity 0.2s';
            document.body.appendChild(flash);
            setTimeout(() => {
                flash.style.opacity = '0';
                setTimeout(() => document.body.removeChild(flash), 200);
            }, 50);
        }

        function showError(msg) {
            errorMsg.innerHTML = msg;
            errorMsg.style.display = 'block';
        }

        // 页面加载即启动
        window.onload = initCamera;

    </script>
</body>
</html>
