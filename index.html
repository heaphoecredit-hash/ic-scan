<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®Œç¾å±…ä¸­ä¿®å¤ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* å…¨å±€æ ·å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }
        body { 
            background: #f0f2f5; 
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; padding-bottom: 90px;
        }

        /* === A4 çº¸å¼ å®¹å™¨ === */
        .paper-container {
            background: white; width: 95vw; max-width: 500px; aspect-ratio: 210/297; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            gap: 45px; padding: 0;
        }

        /* === å¡æ§½ (å›¾ç‰‡ç»å¯¹å±…ä¸­) === */
        .scan-slot {
            width: 85.6mm; height: 54mm; 
            max-width: 90%; aspect-ratio: 85.6/54; 
            border: 2px dashed #9ca3af; background-color: #f9fafb; border-radius: 6px; 
            position: relative; overflow: hidden; cursor: pointer; 
            display: flex; justify-content: center; align-items: center;
        }

        /* è¿™é‡Œçš„CSSç¡®ä¿å›¾ç‰‡æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šåå·¦ï¼Œå¼ºåˆ¶åœ¨çˆ¶å®¹å™¨æ­£ä¸­å¿ƒ */
        .scan-slot img { 
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); /* å¼ºåˆ¶æ‹‰å›ä¸­å¿ƒ */
            width: 100%; height: 100%; 
            object-fit: fill; 
            display: none; z-index: 2;
        }

        .slot-placeholder { text-align: center; color: #9ca3af; pointer-events: none; z-index: 1; }
        .slot-placeholder h3 { font-size: 16px; margin-bottom: 5px; color: #4b5563; }
        .slot-placeholder p { font-size: 12px; }

        /* === åº•éƒ¨æŒ‰é’® === */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); display: flex; gap: 15px; z-index: 50;
        }
        .btn { flex: 1; height: 50px; border-radius: 25px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-main { background: #2563eb; color: white; }
        .btn-sec { background: #f3f4f6; color: #1f2937; }

        /* === ç›¸æœºå…¨å±ç•Œé¢ === */
        .camera-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 999; display: none; justify-content: center; align-items: center;
        }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .mask-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        /* é¡¶éƒ¨æ–‡å­— */
        .guide-text { 
            position: absolute; top: 12%; width: 100%; text-align: center; 
            color: white; font-size: 15px; text-shadow: 0 1px 3px rgba(0,0,0,0.8); z-index: 20; 
        }

        /* === æ“ä½œæŒ‰é’®åŒº === */
        .cam-controls {
            position: absolute; bottom: 30px; width: 100%;
            display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 50;
        }

        /* è‰²å½©åˆ‡æ¢æŒ‰é’® */
        .color-toggle {
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.4);
            color: #4ade80; padding: 8px 20px; border-radius: 20px; font-size: 14px;
            cursor: pointer; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 5px;
        }

        .shutter-row { display: flex; width: 100%; justify-content: space-around; align-items: center; }
        .shutter-btn { 
            width: 76px; height: 76px; background: white; border-radius: 50%; 
            border: 5px solid rgba(200,200,200,0.6); cursor: pointer; transition: transform 0.1s;
        }
        .shutter-btn:active { transform: scale(0.9); background: #e5e5e5; }
        .icon-btn { color: white; background: transparent; border: none; font-size: 14px; padding: 10px; opacity: 0.9; }

        /* è°ƒè¯•ä¿¡æ¯ */
        #debug { position: absolute; top: 10px; left: 10px; color: lime; font-size: 10px; z-index: 100; display: none;}
        
        .generating .scan-slot { border: none; background: white; }
        .generating .slot-placeholder { display: none; }
    </style>
</head>
<body>

    <div class="paper-container" id="pdf-area">
        <div class="scan-slot" onclick="openCamera('front')">
            <div class="slot-placeholder" id="ph-front"><h3>+ èº«ä»½è¯äººåƒé¢</h3><p>ç‚¹å‡»æ‹æ‘„</p></div>
            <img id="img-front">
        </div>
        <div class="scan-slot" onclick="openCamera('back')">
            <div class="slot-placeholder" id="ph-back"><h3>+ èº«ä»½è¯å›½å¾½é¢</h3><p>ç‚¹å‡»æ‹æ‘„</p></div>
            <img id="img-back">
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn btn-sec" onclick="location.reload()">é‡ç½®</button>
        <button class="btn btn-main" onclick="makePDF()">ç”Ÿæˆ PDF</button>
    </div>

    <div class="camera-overlay" id="cam-modal">
        <video id="video" autoplay playsinline muted></video>
        <div id="debug"></div>
        
        <svg class="mask-svg" width="100%" height="100%">
            <defs><mask id="mask-layer"><rect x="0" y="0" width="100%" height="100%" fill="white" /><rect id="cutout-rect" fill="black" rx="8" ry="8" /></mask></defs>
            <rect x="0" y="0" width="100%" height="100%" fill="rgba(0,0,0,0.85)" mask="url(#mask-layer)" />
            <rect id="border-rect" fill="transparent" stroke="#00ff00" stroke-width="2" rx="8" ry="8" />
        </svg>

        <div class="guide-text">è¯·å°†è¯ä»¶<b>å±…ä¸­å¡«æ»¡</b>ç»¿æ¡†</div>

        <div class="cam-controls">
            <button class="color-toggle" id="color-btn" onclick="toggleColor()">
                <span>ğŸ¨ å½“å‰ï¼šå½©è‰²åŸå›¾</span>
            </button>

            <div class="shutter-row">
                <button class="icon-btn" onclick="closeCam()">å–æ¶ˆ</button>
                <button class="shutter-btn" onclick="takePhoto()"></button>
                <button class="icon-btn" onclick="cycleCamera()">åˆ‡æ¢é•œå¤´</button>
            </div>
        </div>
    </div>

    <script>
        let stream = null;
        let side = '';
        let devices = [];
        let devIdx = 0;
        // æ ¸å¿ƒä¿®å¤ï¼šé»˜è®¤ä¸º false (å½©è‰²)ï¼Œé€»è¾‘ä¸€å®šè¦æ¸…æ™°
        let isBW = false; 

        const video = document.getElementById('video');
        const modal = document.getElementById('cam-modal');
        const cutout = document.getElementById('cutout-rect');
        const border = document.getElementById('border-rect');
        const colorBtn = document.getElementById('color-btn');
        const debug = document.getElementById('debug');

        // 1. è‰²å½©åˆ‡æ¢é€»è¾‘
        function toggleColor() {
            isBW = !isBW;
            if (isBW) {
                colorBtn.innerHTML = "ğŸ“„ å½“å‰ï¼šé»‘ç™½å¤å°";
                colorBtn.style.color = "white";
                colorBtn.style.borderColor = "white";
            } else {
                colorBtn.innerHTML = "ğŸ¨ å½“å‰ï¼šå½©è‰²åŸå›¾";
                colorBtn.style.color = "#4ade80"; // ç»¿è‰²
                colorBtn.style.borderColor = "#4ade80";
            }
        }

        // 2. é®ç½©è®¡ç®—
        function updateMask() {
            const sW = window.innerWidth;
            const sH = window.innerHeight;
            // æ‰«ææ¡†å®½åº¦ 88%
            const w = sW * 0.88;
            const h = w / 1.585; 
            // å±…ä¸­åæ ‡
            const x = (sW - w) / 2;
            const y = (sH - h) / 2 - 40;
            
            cutout.setAttribute('x', x); cutout.setAttribute('y', y);
            cutout.setAttribute('width', w); cutout.setAttribute('height', h);
            border.setAttribute('x', x); border.setAttribute('y', y);
            border.setAttribute('width', w); border.setAttribute('height', h);
            return { w, h }; // åªè¿”å›å®½é«˜ï¼Œåæ ‡ç”±ä¸­å¿ƒç®—æ³•å†³å®š
        }

        async function openCamera(s) {
            side = s;
            updateMask();
            modal.style.display = 'flex';
            // é»˜è®¤å°è¯•ç¯å¢ƒé•œå¤´
            await startStream({ video: { facingMode: "environment" } });
            await listDevices();
        }

        async function startStream(consts) {
            if (stream) stream.getTracks().forEach(t => t.stop());
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: false, ...consts });
                video.srcObject = stream;
            } catch (e) {
                alert("ç›¸æœºå¯åŠ¨å¤±è´¥");
            }
        }

        async function listDevices() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return;
            const devs = await navigator.mediaDevices.enumerateDevices();
            devices = devs.filter(d => d.kind === 'videoinput');
            if (stream && devices.length > 0) {
                const track = stream.getVideoTracks()[0];
                const id = track.getSettings().deviceId;
                const idx = devices.findIndex(d => d.deviceId === id);
                if (idx !== -1) devIdx = idx;
                debug.innerText = `Cam: ${devIdx+1}/${devices.length}`;
            }
        }

        async function cycleCamera() {
            if (devices.length < 2) { await listDevices(); if(devices.length<2) return; }
            devIdx = (devIdx + 1) % devices.length;
            await startStream({ video: { deviceId: { exact: devices[devIdx].deviceId }, width: { ideal: 1920 }, height: { ideal: 1080 } } });
        }

        // 3. æ ¸å¿ƒä¿®å¤ï¼šåŸºäºä¸­å¿ƒç‚¹çš„è£å‰ªç®—æ³• (è§£å†³åå·¦é—®é¢˜)
        function takePhoto() {
            if (!stream) return;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const vW = video.videoWidth;
            const vH = video.videoHeight;
            const sW = window.innerWidth;
            const sH = window.innerHeight;

            // ç®—æ³•ï¼šæ— è®ºå±å¹•å’Œè§†é¢‘æ¯”ä¾‹å¦‚ä½•ï¼Œç»¿æ¡†æ˜¯å±å¹•å±…ä¸­çš„ï¼Œé•œå¤´ä¹Ÿæ˜¯å±…ä¸­çš„ã€‚
            // æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æˆªå–è§†é¢‘æºçš„æœ€ä¸­å¿ƒéƒ¨åˆ†ã€‚
            
            // 1. è®¡ç®—ç¼©æ”¾æ¯” (Cover æ¨¡å¼)
            const vidRatio = vW / vH;
            const scrRatio = sW / sH;
            let scale; 
            
            // è¿™é‡Œçš„ scale æ˜¯ï¼šè§†é¢‘æºåƒç´  / å±å¹•åƒç´ 
            if (scrRatio > vidRatio) {
                // å±å¹•æ›´å®½ï¼Œè§†é¢‘å®½åº¦é€‚é…å±å¹•ï¼Œé«˜åº¦è¢«è£
                scale = vW / sW;
            } else {
                // å±å¹•æ›´é«˜ï¼Œè§†é¢‘é«˜åº¦é€‚é…å±å¹•ï¼Œå®½åº¦è¢«è£
                scale = vH / sH;
            }

            // 2. è·å–ç»¿æ¡†åœ¨å±å¹•ä¸Šçš„å°ºå¯¸
            const mask = updateMask(); // { w, h }
            
            // 3. æ˜ å°„å›è§†é¢‘æºçš„å°ºå¯¸
            const srcW = mask.w * scale;
            const srcH = mask.h * scale;

            // 4. è®¡ç®—è§†é¢‘æºçš„èµ·å§‹æˆªå–ç‚¹ (Center - HalfSize)
            const srcX = (vW - srcW) / 2;
            const srcY = (vH - srcH) / 2;

            canvas.width = 1000;
            canvas.height = 1000 / 1.585;

            // 5. ç»˜åˆ¶ (ä»è§†é¢‘ä¸­å¿ƒæˆªå–)
            ctx.drawImage(video, srcX, srcY, srcW, srcH, 0, 0, canvas.width, canvas.height);

            // 6. å¤„ç†é»‘ç™½ (å¦‚æœå¼€å¯)
            if (isBW) {
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imgData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    const val = gray > 110 ? 255 : gray * 0.7;
                    data[i] = data[i+1] = data[i+2] = val;
                }
                ctx.putImageData(imgData, 0, 0);
            }

            const img = document.getElementById('img-' + side);
            const ph = document.getElementById('ph-' + side);
            img.src = canvas.toDataURL('image/jpeg', 0.95);
            img.style.display = 'block';
            ph.style.display = 'none';
            closeCam();
        }

        function closeCam() { modal.style.display = 'none'; if(stream) stream.getTracks().forEach(t=>t.stop()); }

        function makePDF() {
            const el = document.getElementById('pdf-area');
            if (!document.getElementById('img-front').src) { alert("è¯·å…ˆæ‹æ‘„"); return; }
            el.classList.add('generating');
            html2pdf().set({ 
                margin: 0, 
                filename: 'èº«ä»½è¯å¤å°ä»¶.pdf', 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            }).from(el).save().then(() => el.classList.remove('generating'));
        }
        
        window.onresize = updateMask;
    </script>
</body>
</html>
