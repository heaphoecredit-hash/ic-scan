<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>证件复印机终极版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            margin: 0; padding: 0; background: #000; color: #fff;
            font-family: sans-serif; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .camera-box {
            position: relative; flex: 1; background: #000;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        /* 扫描框：视觉引导 */
        .scan-overlay {
            position: absolute; width: 85%; aspect-ratio: 1.58 / 1;
            border: 2px solid #00ff00; border-radius: 4px;
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.7); /* 背景压得更暗，突出主体 */
            z-index: 10; pointer-events: none;
        }
        .hint {
            position: absolute; bottom: -40px; width: 100%; text-align: center;
            font-size: 16px; text-shadow: 1px 1px 2px black; font-weight: bold;
        }
        .controls {
            height: 130px; background: #111;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20;
        }
        .shutter-out {
            width: 70px; height: 70px; border: 4px solid #fff; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
        }
        .shutter-in { width: 58px; height: 58px; background: #fff; border-radius: 50%; }
        .shutter-out:active .shutter-in { transform: scale(0.9); background: #ccc; }
        
        /* 预览层 */
        .preview-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #222; z-index: 50; display: none; flex-direction: column; padding: 20px;
        }
        .res-img {
            width: 100%; max-width: 300px; margin: 10px auto; display: block;
            border: 2px solid #fff;
            /* CSS预览滤镜，让用户提前看到效果 */
            filter: grayscale(100%) contrast(150%) brightness(1.1);
        }
        .btn-pdf {
            margin-top: auto; padding: 18px; background: #00ff00; color: #000;
            border: none; border-radius: 8px; font-size: 18px; font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="camera-box">
        <video id="video" autoplay playsinline muted></video>
        <div class="scan-overlay">
            <div class="hint" id="hintText">请对准 身份证正面</div>
        </div>
    </div>

    <div class="controls">
        <div class="shutter-out" onclick="takePhoto()"><div class="shutter-in"></div></div>
    </div>

    <div class="preview-modal" id="preview">
        <h3 style="text-align:center">复印件预览</h3>
        <p style="text-align:center;color:#aaa">正面</p>
        <img id="img-f" class="res-img">
        <p style="text-align:center;color:#aaa">反面</p>
        <img id="img-b" class="res-img">
        <button class="btn-pdf" onclick="downloadPDF()">下载标准尺寸 A4 PDF</button>
        <button onclick="location.reload()" style="margin-top:10px;padding:10px;background:none;border:none;color:#fff;text-decoration:underline">重新拍摄</button>
    </div>

    <canvas id="cvs" style="display:none;"></canvas>

    <script>
        let step = 1; // 1=正面, 2=反面
        let dataF, dataB;
        const video = document.getElementById('video');
        const cvs = document.getElementById('cvs');
        const ctx = cvs.getContext('2d');

        // 启动相机 (兼容安卓)
        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' }, audio: false 
        }).then(stream => video.srcObject = stream)
          .catch(e => alert("相机启动失败，请检查权限或使用HTTPS"));

        function takePhoto() {
            if (!video.srcObject) return;
            
            // 1. 绘制原始帧
            cvs.width = video.videoWidth;
            cvs.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            // 2. 智能处理：收紧裁切 + 暴力复印滤镜
            const processedData = processImage(cvs);

            if (step === 1) {
                dataF = processedData;
                document.getElementById('hintText').innerText = "请对准 身份证反面";
                step = 2;
                // 闪屏反馈
                document.body.style.backgroundColor = '#fff';
                setTimeout(()=> document.body.style.backgroundColor = '#000', 50);
            } else {
                dataB = processedData;
                video.srcObject.getTracks().forEach(t => t.stop()); // 停止相机
                showPreview();
            }
        }

        // --- 核心：图像处理算法改进 ---
        function processImage(sourceCanvas) {
            const vw = sourceCanvas.width, vh = sourceCanvas.height;
            const ratio = 1.58;
            
            // 【改进点1：更激进的裁切】
            // 之前是用0.85，现在用 0.80 (即只取画面中心80%的区域)，强制去除边缘背景
            const cropFactor = 0.80; 

            let cw, ch, cx, cy;
            if (vw / vh > ratio) {
                ch = vh * cropFactor; cw = ch * ratio;
            } else {
                cw = vw * cropFactor; ch = cw / ratio;
            }
            cx = (vw - cw) / 2; cy = (vh - ch) / 2;

            const tCvs = document.createElement('canvas');
            tCvs.width = cw; tCvs.height = ch;
            const tCtx = tCvs.getContext('2d');
            tCtx.drawImage(sourceCanvas, cx, cy, cw, ch, 0, 0, cw, ch);

            // 【改进点2：二值化复印滤镜】
            const imgData = tCtx.getImageData(0, 0, cw, ch);
            const d = imgData.data;
            // 阈值：大于160的变白，小于的变黑。这个值控制复印件的“黑度”
            const threshold = 160; 

            for (let i = 0; i < d.length; i += 4) {
                // 算出灰度值
                const gray = 0.299 * d[i] + 0.587 * d[i+1] + 0.114 * d[i+2];
                // 暴力二值化：要么是深黑(30)，要么是纯白(255)
                // 不使用纯黑0是为了保留一点点墨粉的质感
                const final = gray > threshold ? 255 : 30;
                d[i] = d[i+1] = d[i+2] = final;
            }
            tCtx.putImageData(imgData, 0, 0);
            return tCvs.toDataURL('image/jpeg', 0.9);
        }

        function showPreview() {
            document.getElementById('img-f').src = dataF;
            document.getElementById('img-b').src = dataB;
            document.getElementById('preview').style.display = 'flex';
        }

        // --- 核心：PDF尺寸精准控制 ---
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            // 【改进点3：强制使用毫米单位】
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

            const a4w = 210; // A4宽度mm
            // 【关键：身份证物理标准宽度 85.6mm】
            const idW = 85.6; 
            const idH = idW / 1.58; 
            const marginX = (a4w - idW) / 2; // 居中计算

            doc.setFontSize(12);
            doc.text("ID Card Copy", a4w/2, 20, { align: 'center' });

            // 精准放置图片
            doc.addImage(dataF, 'JPEG', marginX, 30, idW, idH);
            doc.addImage(dataB, 'JPEG', marginX, 30 + idH + 15, idW, idH);

            doc.save('身份证标准复印件.pdf');
        }
    </script>
</body>
</html>
