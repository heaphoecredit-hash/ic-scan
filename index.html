<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>èº«ä»½è¯é«˜æ¸…æ‰«æ (å…¨å…¼å®¹ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            margin: 0; padding: 0; background: #000; color: #fff;
            font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        .header {
            height: 44px; background: #000; z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; font-size: 16px; font-weight: 600;
        }
        /* åˆ‡æ¢æ‘„åƒå¤´æŒ‰é’® */
        .switch-cam {
            font-size: 14px; padding: 5px 10px; background: #333; 
            border-radius: 4px; border: 1px solid #555; color: #fff;
        }

        .camera-viewport {
            position: relative; flex: 1; background: #111;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; }

        .scan-guide {
            position: absolute;
            width: 85%; aspect-ratio: 1.58 / 1;
            border: 2px solid #2ecc71;
            border-radius: 6px;
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.5);
            pointer-events: none; z-index: 5;
        }
        .guide-label {
            position: absolute; width: 100%; text-align: center;
            bottom: -35px; font-size: 15px; color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }

        .controls {
            height: 140px; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10;
        }
        
        .shutter-btn {
            width: 76px; height: 76px; border: 4px solid #fff; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
        }
        .shutter-inner {
            width: 64px; height: 64px; background: #fff; border-radius: 50%;
            transition: all 0.1s;
        }
        .shutter-btn:active .shutter-inner { transform: scale(0.9); background: #ddd; }

        /* é¢„è§ˆå¼¹çª— */
        .preview-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; z-index: 100;
            display: none; flex-direction: column;
        }
        .preview-body { flex: 1; padding: 20px; overflow-y: auto; text-align: center; }
        .preview-item { margin-bottom: 20px; }
        .preview-label { color: #aaa; font-size: 13px; margin-bottom: 8px; }
        .preview-img {
            width: 70%; border: 1px solid #555; border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .toolbar { padding: 20px; background: #222; display: flex; gap: 15px; }
        .btn {
            flex: 1; padding: 16px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: bold; cursor: pointer;
        }
        .btn-retry { background: #444; color: #fff; }
        .btn-pdf { background: #2ecc71; color: #000; }

        #err-msg {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(200,0,0,0.9); padding: 20px; border-radius: 10px;
            text-align: center; display: none; z-index: 200; width: 80%;
        }
    </style>
</head>
<body>

    <div class="header">
        <span>å½©è‰²æ‰«æ</span>
        <div class="switch-cam" onclick="switchCamera()">ğŸ”„ åˆ‡æ¢é•œå¤´</div>
    </div>

    <div class="camera-viewport">
        <video id="video" autoplay playsinline muted></video>
        <div class="scan-guide">
            <div class="guide-label" id="guide-text">è¯·å¯¹å‡† èº«ä»½è¯æ­£é¢</div>
        </div>
    </div>

    <div class="controls">
        <div class="shutter-btn" onclick="capturePhoto()">
            <div class="shutter-inner"></div>
        </div>
    </div>

    <div class="preview-modal" id="modal">
        <div class="preview-body">
            <h3 style="margin-top:0">æ‰«æé¢„è§ˆ</h3>
            <div class="preview-item">
                <div class="preview-label">æ­£é¢</div>
                <img id="view-f" class="preview-img">
            </div>
            <div class="preview-item">
                <div class="preview-label">åé¢</div>
                <img id="view-b" class="preview-img">
            </div>
        </div>
        <div class="toolbar">
            <button class="btn btn-retry" onclick="location.reload()">é‡æ‹</button>
            <button class="btn btn-pdf" onclick="savePDF()">ä¸‹è½½ PDF</button>
        </div>
    </div>

    <div id="err-msg"></div>
    <canvas id="cvs" style="display:none;"></canvas>

    <script>
        let step = 1; 
        let imgFront = null;
        let imgBack = null;
        
        // æ‘„åƒå¤´ç®¡ç†
        let currentStream = null;
        let videoDevices = [];
        let currentDeviceIndex = 0;

        const video = document.getElementById('video');
        const cvs = document.getElementById('cvs');
        const ctx = cvs.getContext('2d');

        // 1. åˆå§‹åŒ–ï¼šåˆ—å‡ºæ‰€æœ‰æ‘„åƒå¤´
        async function init() {
            try {
                // å…ˆè¯·æ±‚ä¸€æ¬¡æƒé™
                await navigator.mediaDevices.getUserMedia({ video: true });
                
                // è·å–æ‰€æœ‰è®¾å¤‡
                const devices = await navigator.mediaDevices.enumerateDevices();
                // è¿‡æ»¤å‡ºè§†é¢‘è¾“å…¥è®¾å¤‡
                videoDevices = devices.filter(device => device.kind === 'videoinput');

                // å°è¯•æ‰¾åˆ°åç½®æ‘„åƒå¤´ä½œä¸ºé»˜è®¤
                // å®‰å“ä¸Šé€šå¸¸æœ€åä¸€ä¸ªæ˜¯åç½®ä¸»æ‘„ï¼Œæˆ–è€…æ ‡ç­¾åŒ…å« 'back' / 'environment'
                let backCamIndex = videoDevices.findIndex(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('environment'));
                
                if (backCamIndex !== -1) {
                    currentDeviceIndex = backCamIndex;
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°æ˜ç¡®çš„åç½®ï¼Œå°±é»˜è®¤ç”¨æœ€åä¸€ä¸ªï¼ˆé€šå¸¸æ˜¯åç½®ï¼‰
                    currentDeviceIndex = videoDevices.length - 1;
                }

                startCamera(videoDevices[currentDeviceIndex].deviceId);
                
            } catch (err) {
                showError("æ— æ³•è·å–æ‘„åƒå¤´åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚<br>" + err.message);
            }
        }

        // 2. å¯åŠ¨æŒ‡å®š ID çš„æ‘„åƒå¤´
        async function startCamera(deviceId) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            try {
                const constraints = {
                    video: {
                        deviceId: deviceId ? { exact: deviceId } : undefined,
                        // å…³é”®ï¼šå¼ºåˆ¶é«˜æ¸…åˆ†è¾¨ç‡ï¼Œè¿™è¿«ä½¿å®‰å“è°ƒç”¨ä¸»æ‘„åƒå¤´ï¼Œè€Œä¸æ˜¯æ¨¡ç³Šçš„å‰¯æ‘„
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
            } catch (err) {
                // å¦‚æœé«˜æ¸…å¤±è´¥ï¼Œå°è¯•æ™®é€šæ¨¡å¼
                try {
                    const simpleConstraints = {
                        video: { deviceId: deviceId ? { exact: deviceId } : undefined }
                    };
                    currentStream = await navigator.mediaDevices.getUserMedia(simpleConstraints);
                    video.srcObject = currentStream;
                } catch (fatal) {
                    showError("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + fatal.message);
                }
            }
        }

        // 3. æ‰‹åŠ¨åˆ‡æ¢æ‘„åƒå¤´ (ä¿®å¤å®‰å“é—®é¢˜çš„æ ¸å¿ƒ)
        function switchCamera() {
            if (videoDevices.length < 2) {
                alert("æœªæ£€æµ‹åˆ°å¤šä¸ªæ‘„åƒå¤´");
                return;
            }
            // å¾ªç¯åˆ‡æ¢
            currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
            startCamera(videoDevices[currentDeviceIndex].deviceId);
        }

        // 4. æ‹ç…§
        function capturePhoto() {
            if (!video.srcObject) return;

            // ç¡®ä¿è§†é¢‘å·²ç»å‡†å¤‡å¥½ (å®‰å“é˜²é»‘å±)
            if (video.videoWidth === 0) {
                alert("ç›¸æœºå°šæœªå°±ç»ªï¼Œè¯·ç¨ç­‰...");
                return;
            }

            cvs.width = video.videoWidth;
            cvs.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            const processedImg = smartCrop(cvs);

            if (step === 1) {
                imgFront = processedImg;
                step = 2;
                document.getElementById('guide-text').innerText = "è¯·å¯¹å‡† èº«ä»½è¯åé¢";
                // é—ªå±
                document.body.style.opacity = 0.5;
                setTimeout(() => document.body.style.opacity = 1, 100);
            } else {
                imgBack = processedImg;
                showModal();
            }
        }

        // 5. æ™ºèƒ½è£åˆ‡
        function smartCrop(sourceCanvas) {
            const w = sourceCanvas.width;
            const h = sourceCanvas.height;
            const targetRatio = 1.58; 
            const scale = 0.8; 
            
            let cw, ch, cx, cy;
            if (w / h > targetRatio) {
                ch = h * scale; cw = ch * targetRatio;
            } else {
                cw = w * scale; ch = cw / targetRatio;
            }
            cx = (w - cw) / 2;
            cy = (h - ch) / 2;

            const tCvs = document.createElement('canvas');
            tCvs.width = cw; tCvs.height = ch;
            const tCtx = tCvs.getContext('2d');
            tCtx.drawImage(sourceCanvas, cx, cy, cw, ch, 0, 0, cw, ch);
            
            return tCvs.toDataURL('image/jpeg', 0.95);
        }

        function showModal() {
            document.getElementById('view-f').src = imgFront;
            document.getElementById('view-b').src = imgBack;
            document.getElementById('modal').style.display = 'flex';
        }

        function savePDF() {
            const { jsPDF } = window.jspdf;
            const doc =
