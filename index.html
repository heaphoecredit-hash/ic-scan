<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>身份证高清扫描(带引导框)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary-color: #3b82f6; }
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
        
        body {
            background-color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: 80px; /* 留出底部按钮空间 */
        }

        /* === 1. A4 预览区域 === */
        .pdf-container {
            margin-top: 20px;
            background: white;
            width: 95vw;
            max-width: 595px; /* A4 宽度 */
            aspect-ratio: 210/297;
            padding: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            align-items: center;
        }

        .id-card-slot {
            width: 85.6%; /* 身份证标准比例 */
            height: 42%;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            background-color: #f8fafc;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .id-card-slot img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .slot-tips { text-align: center; color: #94a3b8; pointer-events: none; }
        .slot-tips h4 { margin-bottom: 5px; color: #64748b; }
        .slot-tips p { font-size: 12px; }

        /* === 2. 自定义相机界面 (全屏覆盖) === */
        #camera-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 999;
            display: none; /* 默认隐藏 */
            flex-direction: column;
        }

        /* 视频流 */
        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 遮罩层 (实现中间亮四周暗) */
        .camera-mask {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none; /* 让点击穿透 */
        }

        /* 引导框 */
        .guide-box {
            width: 80vw;
            height: 50.4vw; /* 保持身份证比例 */
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6); /* 巨大的阴影作为遮罩 */
            position: relative;
        }

        /* 引导框四个角 */
        .guide-box::after {
            content: "请将证件放入框内";
            position: absolute;
            top: -40px;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 16px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        /* 相机控制栏 */
        .camera-controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 20px;
        }

        .cam-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }

        .shutter-btn {
            width: 70px; height: 70px;
            background: white;
            border-radius: 50%;
            border: 4px solid rgba(200,200,200,0.5);
            cursor: pointer;
        }
        .shutter-btn:active { transform: scale(0.9); background: #eee; }

        /* === 3. 底部操作栏 === */
        .main-controls {
            position: fixed;
            bottom: 20px;
            width: 90%;
            max-width: 400px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        .action-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
        }
        .btn-blue { background: var(--primary-color); color: white; }
        .btn-white { background: white; color: #333; }

        /* 生成PDF时的样式修正 */
        .generating .id-card-slot { border: 1px solid #ddd; }
        .generating .slot-tips { display: none; }
        
        /* 错误提示 */
        #error-msg {
            display: none;
            position: fixed; top: 10px;
            background: #ef4444; color: white;
            padding: 10px 20px; border-radius: 8px; font-size: 12px;
            z-index: 2000;
        }
    </style>
</head>
<body>

    <div id="error-msg">错误：无法启动相机。请确保使用HTTPS访问或已授权。</div>

    <h3 style="margin-top:20px; color:#333;">身份证扫描工具</h3>

    <div class="pdf-container" id="pdf-content">
        <div class="id-card-slot" onclick="openCamera('front')">
            <div class="slot-tips" id="tip-front">
                <h4>人像面</h4>
                <p>点击开启相机扫描</p>
            </div>
            <img id="img-front">
        </div>

        <div class="id-card-slot" onclick="openCamera('back')">
            <div class="slot-tips" id="tip-back">
                <h4>国徽面</h4>
                <p>点击开启相机扫描</p>
            </div>
            <img id="img-back">
        </div>
    </div>

    <div class="main-controls">
        <button class="action-btn btn-white" onclick="location.reload()">重置</button>
        <button class="action-btn btn-blue" onclick="generatePDF()">生成 PDF</button>
    </div>

    <div id="camera-modal">
        <video id="camera-feed" autoplay playsinline muted></video>
        
        <div class="camera-mask">
            <div class="guide-box"></div>
        </div>

        <div class="camera-controls">
            <button class="cam-btn" onclick="closeCamera()">取消</button>
            <button class="shutter-btn" onclick="takePhoto()"></button>
            <button class="cam-btn" onclick="switchCameraMode()">切换镜头</button>
        </div>
    </div>

    <script>
        let currentStream = null;
        let currentSide = 'front';
        let useFrontCamera = false; // 默认使用后置
        
        const video = document.getElementById('camera-feed');
        const modal = document.getElementById('camera-modal');
        const errorMsg = document.getElementById('error-msg');

        // 1. 打开相机
        async function openCamera(side) {
            currentSide = side;
            modal.style.display = 'flex';
            errorMsg.style.display = 'none';
            await startStream();
        }

        // 2. 启动视频流
        async function startStream() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    facingMode: useFrontCamera ? 'user' : 'environment', // environment 代表后置
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                },
                audio: false
            };

            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
            } catch (err) {
                console.error("相机启动失败:", err);
                errorMsg.innerHTML = "相机启动失败：请检查浏览器权限，且必须使用HTTPS协议。";
                errorMsg.style.display = 'block';
            }
        }

        // 3. 拍照并截取
        function takePhoto() {
            if (!currentStream) return;

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // 设置画布为视频的实际分辨率
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // 绘制当前帧
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // 获取图片数据
            const dataURL = canvas.toDataURL('image/jpeg', 0.9);

            // 显示在主界面
            const img = document.getElementById('img-' + currentSide);
            const tip = document.getElementById('tip-' + currentSide);
            img.src = dataURL;
            img.style.display = 'block';
            tip.style.display = 'none';

            // 关闭相机
            closeCamera();
        }

        // 4. 关闭相机
        function closeCamera() {
            modal.style.display = 'none';
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        // 5. 切换前后置
        function switchCameraMode() {
            useFrontCamera = !useFrontCamera;
            startStream();
        }

        // 6. 生成PDF
        function generatePDF() {
            const element = document.getElementById('pdf-content');
            
            // 简单校验
            if (!document.getElementById('img-front').src && !document.getElementById('img-back').src) {
                alert("请先拍摄证件照");
                return;
            }

            element.classList.add('generating'); // 去除虚线边框

            const opt = {
                margin: 0,
                filename: '身份证扫描件.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.classList.remove('generating');
            });
        }
    </script>
</body>
</html>
