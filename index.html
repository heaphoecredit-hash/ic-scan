<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>IC 正反面一页（安卓专用）</title>
  <style>
    :root{
      --bg:#0b0b0f; --card:#12121a; --line:#2a2a36; --txt:#fff; --muted:#b9b9c6;
      --btn:#ffffff; --btnTxt:#000; --accent:#00d084;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .top{
      position:sticky; top:0; z-index:10;
      padding:10px 12px calc(10px + env(safe-area-inset-top));
      background:linear-gradient(to bottom, rgba(11,11,15,.95), rgba(11,11,15,.75));
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    select, button{
      border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); color:var(--txt);
      padding:10px 12px; font-size:14px;
    }
    button.primary{background:var(--btn); color:var(--btnTxt); border-color:transparent; font-weight:600}
    button.ghost{background:transparent}
    button:disabled{opacity:.45}
    .hint{margin:8px 0 0; color:var(--muted); font-size:12px; line-height:1.35}

    .stage{padding:12px; display:grid; gap:12px; max-width:980px; margin:0 auto}
    .viewer{
      background:var(--card); border:1px solid rgba(255,255,255,.08);
      border-radius:18px; overflow:hidden;
    }
    video{width:100%; height:56vh; background:#000; object-fit:cover; display:block}
    .bigBtns{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
      padding:12px;
      background:rgba(0,0,0,.15);
      border-top:1px solid rgba(255,255,255,.06);
    }
    .bigBtns button{
      padding:14px 12px; font-size:16px; border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
    }
    .bigBtns button.primary{background:var(--accent); color:#00120a; border-color:transparent; font-weight:800}

    .shots{
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
    }
    .shot{
      background:var(--card); border:1px solid rgba(255,255,255,.08);
      border-radius:18px; overflow:hidden; display:flex; flex-direction:column;
    }
    .shot header{
      padding:10px 12px; display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid rgba(255,255,255,.06);
      color:var(--muted); font-size:13px;
    }
    .shot img{width:100%; height:170px; object-fit:contain; background:#fff}
    .shot .actions{padding:10px 12px; display:flex; gap:8px; flex-wrap:wrap}
    .shot .actions button{flex:1}

    /* A4 打印页 */
    .pageWrap{max-width:980px; margin:0 auto; padding:0 12px 16px}
    .page{
      width:210mm; min-height:297mm; background:#fff; color:#000;
      margin:0 auto; border-radius:16px; overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .pageInner{padding:12mm}
    .pageTitle{font-weight:700; font-size:14px; margin:0 0 8mm}
    .printRow{display:grid; grid-template-columns:1fr 1fr; gap:10mm}
    .pLabel{font-size:12px; margin:0 0 3mm; color:#111}
    .pBox{border:1px solid #999; border-radius:10px; padding:6mm; min-height:150mm; display:flex; align-items:center; justify-content:center}
    .pBox img{max-width:100%; max-height:135mm; object-fit:contain}

    @media print{
      body{background:#fff}
      .top,.stage{display:none !important}
      .pageWrap{padding:0 !important}
      .page{border:none;border-radius:0;width:auto;min-height:auto}
      @page{size:A4;margin:0}
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="row">
      <button id="btnStart" class="primary">开启后摄</button>
      <button id="btnStop" class="ghost" disabled>关闭</button>
      <select id="selCam" title="摄像头"></select>
      <button id="btnTorch" class="ghost" disabled>闪光灯</button>
      <button id="btnPrint" class="primary" disabled>打印 / 存 PDF</button>
      <button id="btnReset" class="ghost">清空</button>
    </div>
    <div class="hint">
      重要：此页面必须用 <b>HTTPS</b> 打开（或 localhost）。请用安卓 <b>Chrome</b>，不要用微信/WhatsApp 内建浏览器。
    </div>
  </div>

  <div class="stage">
    <div class="viewer">
      <video id="video" playsinline autoplay muted></video>
      <div class="bigBtns">
        <button id="capFront" class="primary" disabled>拍 IC 正面</button>
        <button id="capBack"  class="primary" disabled>拍 IC 反面</button>
      </div>
    </div>

    <div class="shots">
      <div class="shot">
        <header><span>正面预览</span><span id="frontState">未拍</span></header>
        <img id="imgFront" alt="front" />
        <div class="actions">
          <button id="rotFront" disabled>旋转</button>
          <button id="retakeFront" disabled>重拍</button>
        </div>
      </div>
      <div class="shot">
        <header><span>反面预览</span><span id="backState">未拍</span></header>
        <img id="imgBack" alt="back" />
        <div class="actions">
          <button id="rotBack" disabled>旋转</button>
          <button id="retakeBack" disabled>重拍</button>
        </div>
      </div>
    </div>
  </div>

  <div class="pageWrap">
    <div class="page" id="page">
      <div class="pageInner">
        <p class="pageTitle">IC（正反面）同一页</p>
        <div class="printRow">
          <div>
            <p class="pLabel">正面</p>
            <div class="pBox"><img id="printFront" alt="print front"></div>
          </div>
          <div>
            <p class="pLabel">反面</p>
            <div class="pBox"><img id="printBack" alt="print back"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <canvas id="canvas" style="display:none"></canvas>

<script>
(() => {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const btnTorch = document.getElementById('btnTorch');
  const btnPrint = document.getElementById('btnPrint');
  const btnReset = document.getElementById('btnReset');
  const selCam   = document.getElementById('selCam');

  const capFront = document.getElementById('capFront');
  const capBack  = document.getElementById('capBack');

  const imgFront = document.getElementById('imgFront');
  const imgBack  = document.getElementById('imgBack');
  const printFront = document.getElementById('printFront');
  const printBack  = document.getElementById('printBack');

  const rotFront = document.getElementById('rotFront');
  const rotBack  = document.getElementById('rotBack');
  const retakeFront = document.getElementById('retakeFront');
  const retakeBack  = document.getElementById('retakeBack');

  const frontState = document.getElementById('frontState');
  const backState  = document.getElementById('backState');

  let stream = null;
  let track  = null;
  let torchOn = false;

  function isSecureOk() {
    const ok = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if (!ok) {
      alert('安卓相机需要 HTTPS（或 localhost）。请把此 HTML 放到 HTTPS 网站再打开。');
    }
    return ok;
  }

  async function listCams() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    selCam.innerHTML = '';
    cams.forEach((c, i) => {
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.textContent = c.label || `Camera ${i+1}`;
      selCam.appendChild(opt);
    });
  }

  function setUIRunning(running) {
    btnStop.disabled = !running;
    capFront.disabled = !running;
    capBack.disabled = !running;
  }

  function canPrint() {
    const ok = !!printFront.src && !!printBack.src;
    btnPrint.disabled = !ok;
  }

  async function startCamera(deviceId) {
    if (!isSecureOk()) return;

    stopCamera();

    const constraints = {
      video: deviceId
        ? { deviceId: { exact: deviceId } }
        : { facingMode: { ideal: 'environment' } },
      audio: false
    };

    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;

    const tracks = stream.getVideoTracks();
    track = tracks[0];

    await listCams();

    const caps = track.getCapabilities ? track.getCapabilities() : {};
    btnTorch.disabled = !caps.torch;

    setUIRunning(true);
  }

  function stopCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = null;
    track = null;
    video.srcObject = null;
    btnTorch.disabled = true;
    torchOn = false;
    setUIRunning(false);
  }

  async function toggleTorch() {
    if (!track) return;
    const caps = track.getCapabilities ? track.getCapabilities() : {};
    if (!caps.torch) return;
    torchOn = !torchOn;
    try {
      await track.applyConstraints({ advanced: [{ torch: torchOn }] });
    } catch (e) {
      torchOn = !torchOn;
      alert('此设备/浏览器不支持控制闪光灯。');
    }
  }

  function capture() {
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    if (!vw || !vh) return null;

    canvas.width = vw;
    canvas.height = vh;
    ctx.drawImage(video, 0, 0, vw, vh);

    return canvas.toDataURL('image/jpeg', 0.92);
  }

  function rotate90(dataUrl) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const w = img.width, h = img.height;
        canvas.width = h; canvas.height = w;
        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.rotate(Math.PI/2);
        ctx.drawImage(img, -w/2, -h/2);
        ctx.restore();
        resolve(canvas.toDataURL('image/jpeg', 0.92));
      };
      img.src = dataUrl;
    });
  }

  function setFront(src) {
    imgFront.src = src || '';
    printFront.src = src || '';
    frontState.textContent = src ? '已拍' : '未拍';
    rotFront.disabled = !src;
    retakeFront.disabled = !src ? true : false; // 开相机后才能重拍
    canPrint();
  }

  function setBack(src) {
    imgBack.src = src || '';
    printBack.src = src || '';
    backState.textContent = src ? '已拍' : '未拍';
    rotBack.disabled = !src;
    retakeBack.disabled = !src ? true : false;
    canPrint();
  }

  // Buttons
  btnStart.addEventListener('click', async () => {
    try {
      await startCamera(selCam.value || null);
    } catch (e) {
      const msg = (e && e.name) ? e.name : String(e);
      alert('开启相机失败：' + msg + '\n\n常见原因：未用HTTPS、未给相机权限、或被其他App占用。');
    }
  });

  btnStop.addEventListener('click', stopCamera);
  btnTorch.addEventListener('click', toggleTorch);

  selCam.addEventListener('change', async () => {
    if (!selCam.value) return;
    try { await startCamera(selCam.value); }
    catch (e) { alert('切换摄像头失败：' + (e?.name || e)); }
  });

  capFront.addEventListener('click', () => {
    const src = capture();
    if (!src) return;
    setFront(src);
    retakeFront.disabled = false;
  });

  capBack.addEventListener('click', () => {
    const src = capture();
    if (!src) return;
    setBack(src);
    retakeBack.disabled = false;
  });

  rotFront.addEventListener('click', async () => {
    if (!imgFront.src) return;
    setFront(await rotate90(imgFront.src));
  });

  rotBack.addEventListener('click', async () => {
    if (!imgBack.src) return;
    setBack(await rotate90(imgBack.src));
  });

  retakeFront.addEventListener('click', () => { if (!capFront.disabled) capFront.click(); });
  retakeBack.addEventListener('click', () => { if (!capBack.disabled) capBack.click(); });

  btnPrint.addEventListener('click', () => window.print());

  btnReset.addEventListener('click', () => {
    setFront('');
    setBack('');
    btnPrint.disabled = true;
  });

  // Init
  if (navigator.mediaDevices?.enumerateDevices) {
    navigator.mediaDevices.enumerateDevices().then(listCams).catch(()=>{});
  }
})();
</script>
</body>
</html>
