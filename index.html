<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>强制后置相机修复版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* === 样式与之前保持一致，无变化 === */
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }
        body { 
            background: #e5e5e5; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; padding-bottom: 90px;
        }
        .paper-container {
            background: white; width: 95vw; max-width: 500px; aspect-ratio: 210/297; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; 
            justify-content: center; align-items: center; gap: 50px; padding: 0;
        }
        .scan-slot {
            width: 85.6mm; height: 54mm; max-width: 90%; aspect-ratio: 85.6/54; 
            border: 2px dashed #ccc; background-color: #f9f9f9; border-radius: 4px; 
            position: relative; overflow: hidden; cursor: pointer; display: flex; 
            justify-content: center; align-items: center;
        }
        .scan-slot img { width: 100%; height: 100%; object-fit: fill; display: none; }
        .slot-placeholder { text-align: center; color: #999; pointer-events: none; }
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); display: flex; gap: 15px; z-index: 50;
        }
        .btn { flex: 1; height: 50px; border-radius: 25px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-main { background: #2563eb; color: white; }
        .btn-sec { background: #f1f5f9; color: #333; }
        
        .camera-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 999; display: none; justify-content: center; align-items: center;
        }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .mask-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .guide-text { position: absolute; top: 12%; width: 100%; text-align: center; color: white; font-size: 16px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 20; }
        .guide-text b { color: #00ff00; }
        .cam-actions { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: space-around; align-items: center; z-index: 20; }
        .shutter-btn { width: 72px; height: 72px; background: white; border-radius: 50%; border: 5px solid rgba(220,220,220,0.5); cursor: pointer; }
        .close-btn { color: white; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.3); font-size: 14px; padding: 10px 20px; border-radius: 20px; backdrop-filter: blur(5px);}
        .generating .scan-slot { border: none; background: white; }
        .generating .slot-placeholder { display: none; }
    </style>
</head>
<body>
    
    <div class="paper-container" id="pdf-area">
        <div class="scan-slot" onclick="openCamera('front')">
            <div class="slot-placeholder" id="ph-front"><h3>+ 身份证人像面</h3><p>点击拍摄</p></div>
            <img id="img-front">
        </div>
        <div class="scan-slot" onclick="openCamera('back')">
            <div class="slot-placeholder" id="ph-back"><h3>+ 身份证国徽面</h3><p>点击拍摄</p></div>
            <img id="img-back">
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn btn-sec" onclick="location.reload()">重置</button>
        <button class="btn btn-main" onclick="makePDF()">生成 PDF</button>
    </div>

    <div class="camera-overlay" id="cam-modal">
        <video id="video" autoplay playsinline muted></video>
        <svg class="mask-svg" width="100%" height="100%">
            <defs><mask id="mask-layer"><rect x="0" y="0" width="100%" height="100%" fill="white" /><rect id="cutout-rect" fill="black" rx="8" ry="8" /></mask></defs>
            <rect x="0" y="0" width="100%" height="100%" fill="rgba(0,0,0,0.9)" mask="url(#mask-layer)" />
            <rect id="border-rect" fill="transparent" stroke="#00ff00" stroke-width="2" rx="8" ry="8" />
        </svg>
        <div class="guide-text">请将证件<b>填满</b>绿框</div>
        <div class="cam-actions">
            <button class="close-btn" onclick="closeCam()">取消</button>
            <button class="shutter-btn" onclick="takePhoto()"></button>
            <button class="close-btn" onclick="toggleMode()">切换镜头</button>
        </div>
    </div>

    <script>
        let currentStream = null;
        let currentSide = '';
        // 核心开关：true 代表我们要后置，false 代表要前置
        let isBackCamera = true; 
        
        const video = document.getElementById('video');
        const modal = document.getElementById('cam-modal');
        const cutout = document.getElementById('cutout-rect');
        const border = document.getElementById('border-rect');

        function adjustMask() {
            const sW = window.innerWidth; const sH = window.innerHeight;
            const bW = sW * 0.88; const bH = bW / 1.585;
            const x = (sW - bW) / 2; const y = (sH - bH) / 2 - 40;
            cutout.setAttribute('x', x); cutout.setAttribute('y', y); cutout.setAttribute('width', bW); cutout.setAttribute('height', bH);
            border.setAttribute('x', x); border.setAttribute('y', y); border.setAttribute('width', bW); border.setAttribute('height', bH);
            return { x, y, w: bW, h: bH };
        }

        // 1. 打开相机（入口）
        function openCamera(side) {
            currentSide = side;
            adjustMask();
            modal.style.display = 'flex';
            startCameraStream();
        }

        // 2. 核心：启动流（不再查找设备ID，而是指定模式）
        async function startCameraStream() {
            // 先彻底停止旧流
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }

            // 定义约束条件：根据 isBackCamera 开关决定
            // exact: "environment" 是 iOS 强制后置的关键词
            const constraints = {
                audio: false,
                video: {
                    facingMode: isBackCamera ? { exact: "environment" } : "user",
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            };

            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
            } catch (err) {
                console.warn("First attempt failed:", err);
                
                // 如果第一次失败（比如设备不支持 exact 语法），尝试降级方案
                if (isBackCamera) {
                    try {
                        // 降级1：去掉 exact，只请求 environment
                        const fallbackConstraints = {
                            audio: false,
                            video: { facingMode: "environment" }
                        };
                        currentStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                        video.srcObject = currentStream;
                    } catch (err2) {
                        console.error("Fallback failed:", err2);
                        // 降级2：什么都不要求，只要是个相机就行
                        try {
                            currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
                            video.srcObject = currentStream;
                        } catch(e) {
                            alert("无法启动相机，请检查权限设置");
                        }
                    }
                }
            }
        }

        // 3. 切换镜头逻辑
        function toggleMode() {
            isBackCamera = !isBackCamera; // 翻转开关
            startCameraStream(); // 重启相机
        }

        function closeCam() {
            modal.style.display = 'none';
            if (currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
                currentStream = null;
            }
        }

        function takePhoto() {
            if (!currentStream) return;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const vW = video.videoWidth; const vH = video.videoHeight;
            const sW = window.innerWidth; const sH = window.innerHeight;
            const vR = vW / vH; const sR = sW / sH;
            let rW, rH;
            if (sR > vR) { rW = sW; rH = sW / vR; } else { rH = sH; rW = sH * vR; }
            const scale = vW / rW;
            const mask = adjustMask();
            const oX = (rW - sW) / 2; const oY = (rH - sH) / 2;
            const sx = (mask.x + oX) * scale; const sy = (mask.y + oY) * scale;
            const sw = mask.w * scale; const sh = mask.h * scale;
            canvas.width = 1000; canvas.height = 1000 / 1.585;
            ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);

            // 自动美化（去底色）
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                const val = gray > 110 ? 255 : gray * 0.7; 
                data[i] = data[i+1] = data[i+2] = val;
            }
            ctx.putImageData(imgData, 0, 0);

            const img = document.getElementById('img-' + currentSide);
            const ph = document.getElementById('ph-' + currentSide);
            img.src = canvas.toDataURL('image/jpeg', 0.9);
            img.style.display = 'block';
            ph.style.display = 'none';
            closeCam();
        }

        function makePDF() {
            const el = document.getElementById('pdf-area');
            if (!document.getElementById('img-front').src && !document.getElementById('img-back').src) {
                alert("请先完成拍摄"); return;
            }
            el.classList.add('generating');
            html2pdf().set({
                margin: 0,
                filename: '身份证复印件.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(el).save().then(() => el.classList.remove('generating'));
        }
        window.onresize = adjustMask;
    </script>
</body>
</html>
