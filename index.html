<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¯ä»¶æ‹ç…§ä¸Šä¼ ä¿®å¤ç‰ˆ</title>
    <style>
        /* 1. å…¨å±€é‡ç½®ï¼Œé˜²æ­¢æµè§ˆå™¨é»˜è®¤è¾¹è·å½±å“å¸ƒå±€ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 2. é¢„è§ˆåŒºåŸŸå®¹å™¨ - è§£å†³â€œåå·¦â€çš„æ ¸å¿ƒ */
        .preview-container {
            width: 100%;
            max-width: 400px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œæ¨¡ä»¿èº«ä»½è¯æ¯”ä¾‹ */
            height: 250px;    /* å›ºå®šé«˜åº¦ */
            background-color: #333; /* æ·±è‰²èƒŒæ™¯ï¼Œæ–¹ä¾¿çœ‹æ¸…å›¾ç‰‡è¾¹ç•Œ */
            border-radius: 8px;
            border: 2px dashed #999;
            
            /* ã€æ ¸å¿ƒä¿®å¤ã€‘Flex å¸ƒå±€å¼ºåˆ¶å†…å®¹å±…ä¸­ */
            display: flex;
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center;     /* å‚ç›´å±…ä¸­ */
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }

        /* 3. å›¾ç‰‡æœ¬èº« - è§£å†³â€œå˜å½¢/åå·¦â€çš„æ ¸å¿ƒ */
        #preview-img {
            display: block;
            /* åªè¦å›¾ç‰‡å­˜åœ¨å°±æ˜¾ç¤ºï¼Œå¦åˆ™éšè— */
            opacity: 0; 
            transition: opacity 0.3s;
            
            /* ã€ç»å¯¹å…³é”®ã€‘æ— è®ºå›¾ç‰‡æ¨ªç«–ï¼Œéƒ½ä¿æŒæ¯”ä¾‹ç¼©æ”¾æ”¾è¿›æ¡†å†… */
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
        }

        /* æç¤ºæ–‡å­— */
        .placeholder-text {
            position: absolute;
            color: #fff;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ */
        }

        /* 4. æŒ‰é’®æ ·å¼ */
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .btn {
            border: 2px solid gray;
            color: white;
            background-color: #007bff;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            text-align: center;
        }

        /* 5. çœŸæ­£çš„ input - éšè—è¦†ç›–åœ¨æŒ‰é’®ä¸Š */
        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* åŠ è½½ä¸­æç¤º */
        #loading {
            display: none;
            margin-top: 10px;
            color: #666;
        }
    </style>
</head>
<body>

    <div class="preview-container">
        <span class="placeholder-text" id="placeholder">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‹ç…§</span>
        <img id="preview-img" src="" alt="é¢„è§ˆå›¾">
    </div>

    <div class="upload-btn-wrapper">
        <button class="btn">ğŸ“· æ‹æ‘„ / ä¸Šä¼ è¯ä»¶</button>
        <input type="file" id="file-input" accept="image/*" capture="environment" onchange="handleFile(this)">
    </div>

    <div id="loading">æ­£åœ¨å¤„ç†å›¾ç‰‡ï¼Œè¯·ç¨å€™...</div>

    <script>
        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.getElementById('placeholder').style.display = 'none';

            // 1. è¯»å–æ–‡ä»¶
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                
                // ç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå†å¤„ç†
                img.onload = function() {
                    // 2. åˆ›å»º Canvas è¿›è¡Œæ ¼å¼æ¸…æ´—
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // è®¾ç½® Canvas å¤§å°ç­‰äºå›¾ç‰‡å®é™…å¤§å°
                    canvas.width = img.width;
                    canvas.height = img.height;

                    // 3. ç»˜åˆ¶å›¾ç‰‡ (è¿™ä¸€æ­¥ä¼šå»é™¤ iOS HEIC çš„ç‰¹æ®Šç¼–ç )
                    ctx.drawImage(img, 0, 0, img.width, img.height);

                    // 4. ã€æ ¸å¿ƒã€‘å¼ºåˆ¶è½¬ä¸º JPG Base64
                    // quality 0.7 é€‚åº¦å‹ç¼©ï¼Œé˜²æ­¢æ–‡ä»¶è¿‡å¤§å¯¼è‡´ä¸Šä¼ æ…¢
                    const dataURL = canvas.toDataURL('image/jpeg', 0.7);

                    // 5. æ˜¾ç¤ºå›¾ç‰‡
                    const previewImg = document.getElementById('preview-img');
                    previewImg.src = dataURL;
                    previewImg.style.opacity = '1';

                    // éšè—åŠ è½½æç¤º
                    document.getElementById('loading').style.display = 'none';

                    // === æ³¨æ„ ===
                    // æ­¤æ—¶ dataURL å·²ç»æ˜¯æ ‡å‡†çš„ JPG æ ¼å¼å­—ç¬¦ä¸²
                    // å¦‚æœä½ è¦å‘ç»™åå°ï¼Œå°±å‘è¿™ä¸ª dataURLï¼Œæˆ–è€…æŠŠå®ƒè½¬å› Blob
                    console.log("å›¾ç‰‡å·²è½¬æ¢ä¸ºæ ‡å‡† JPGï¼Œé•¿åº¦:", dataURL.length);
                };

                img.onerror = function() {
                    alert("å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•");
                    document.getElementById('loading').style.display = 'none';
                };

                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>
