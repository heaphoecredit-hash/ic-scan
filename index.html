<!doctype html>
<html lang="zh-Hans">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>IC 正反面 A4（防抖版）</title>

<style>
:root{
  --bg:#0b0b0f; --card:#12121a; --txt:#fff;
  --accent:#00d084; --warn:#ffb020; --bad:#ff4d4f;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--txt);
font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

.top{position:sticky;top:0;z-index:10;padding:10px 12px;background:rgba(11,11,15,.9)}
button{padding:12px 14px;border-radius:14px;border:none;font-size:15px;font-weight:700}
.primary{background:var(--accent);color:#00120a}
.ghost{background:#2a2a36;color:#fff}
button:disabled{opacity:.5}

.viewer{position:relative}
video{width:100%;height:65vh;object-fit:cover;background:#000}

.frame{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
.frameBox{
  width:86vw;max-width:420px;aspect-ratio:85.6/54;
  border:3px solid var(--accent);border-radius:14px;
  box-shadow:0 0 0 9999px rgba(0,0,0,.45)
}

/* 防抖提示 */
.hint{
  position:absolute;bottom:14px;left:50%;transform:translateX(-50%);
  padding:8px 14px;border-radius:999px;font-weight:700;font-size:14px;
  background:#222;color:#fff
}
.hint.ok{background:var(--accent);color:#00120a}
.hint.warn{background:var(--warn);color:#000}
.hint.bad{background:var(--bad)}

.controls{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px}
.preview{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
.preview img{width:100%;height:160px;object-fit:contain;background:#fff;border-radius:12px}

/* A4 */
.page{width:210mm;min-height:297mm;background:#fff;color:#000;margin:0 auto;padding:12mm}
.pBox{height:120mm;border:1px solid #999;border-radius:10px;
display:flex;align-items:center;justify-content:center;margin-bottom:8mm}
.pBox img{max-width:100%;max-height:108mm;object-fit:contain}

@media print{
  body{background:#fff}
  .top,.viewer,.controls,.preview{display:none}
  @page{size:A4;margin:0}
}
</style>
</head>

<body>

<div class="top">
  <button id="start" class="primary">开启相机</button>
  <button id="print" class="ghost" disabled>保存 PDF</button>
</div>

<div class="viewer">
  <video id="video" autoplay playsinline muted></video>
  <div class="frame"><div class="frameBox"></div></div>
  <div id="hint" class="hint warn">请放稳手机</div>
</div>

<div class="controls">
  <button id="front" class="primary" disabled>拍 IC 正面</button>
  <button id="back"  class="primary" disabled>拍 IC 反面</button>
</div>

<div class="preview">
  <img id="imgFront">
  <img id="imgBack">
</div>

<div class="page">
  <div class="pBox"><img id="printFront"></div>
  <div class="pBox"><img id="printBack"></div>
</div>

<canvas id="canvas" hidden></canvas>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const startBtn = document.getElementById('start');
const frontBtn = document.getElementById('front');
const backBtn  = document.getElementById('back');
const printBtn = document.getElementById('print');
const hint = document.getElementById('hint');

const imgFront = document.getElementById('imgFront');
const imgBack  = document.getElementById('imgBack');
const printFront = document.getElementById('printFront');
const printBack  = document.getElementById('printBack');

const IC_RATIO = 85.6 / 54;

// ===== 相机 =====
startBtn.onclick = async ()=>{
  const s = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{ideal:'environment'}},audio:false
  });
  video.srcObject = s;
  startMotion();
};

// ===== 防抖 =====
let lastMove = Date.now();
let stable = false;

function startMotion(){
  if(!window.DeviceMotionEvent){
    stable = true; enableShoot(); return;
  }
  window.addEventListener('devicemotion', e=>{
    const a = e.accelerationIncludingGravity;
    if(!a) return;
    const mag = Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z);
    if(mag > 25){ // 晃动阈值
      lastMove = Date.now();
      stable = false;
      disableShoot("请放稳手机");
    }
  });

  setInterval(()=>{
    if(Date.now()-lastMove > 600){
      stable = true;
      enableShoot();
    }
  },200);
}

function enableShoot(){
  frontBtn.disabled = false;
  backBtn.disabled = false;
  hint.textContent = "稳定，可拍照";
  hint.className = "hint ok";
}
function disableShoot(text){
  frontBtn.disabled = true;
  backBtn.disabled = true;
  hint.textContent = text;
  hint.className = "hint warn";
}

// ===== 拍 IC =====
function captureIC(){
  const vw = video.videoWidth, vh = video.videoHeight;
  let cw = vw, ch = cw / IC_RATIO;
  if(ch > vh){ ch = vh; cw = ch * IC_RATIO; }
  const sx = (vw-cw)/2, sy = (vh-ch)/2;
  const outW = 1400, outH = outW / IC_RATIO;
  canvas.width = outW; canvas.height = outH;
  ctx.drawImage(video,sx,sy,cw,ch,0,0,outW,outH);
  return canvas.toDataURL('image/jpeg',0.92);
}

frontBtn.onclick = ()=>{
  if(!stable) return;
  const img = captureIC();
  imgFront.src = img; printFront.src = img; check();
};
backBtn.onclick = ()=>{
  if(!stable) return;
  const img = captureIC();
  imgBack.src = img; printBack.src = img; check();
};

function check(){
  if(printFront.src && printBack.src) printBtn.disabled = false;
}
printBtn.onclick = ()=>window.print();
</script>

</body>
</html>
