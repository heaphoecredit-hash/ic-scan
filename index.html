<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¯ä»¶æ‰«æç»ˆæå®Œç¾ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* === 1. åŸºç¡€é‡ç½® === */
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { 
            background: #f0f2f5; 
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; padding-bottom: 90px;
            overflow-x: hidden;
        }

        /* === 2. A4 çº¸å¼ å®¹å™¨ === */
        .paper-container {
            background: white; 
            width: 95vw; max-width: 500px; aspect-ratio: 210/297; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
            border-radius: 4px;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            gap: 50px; /* ä¸Šä¸‹ç…§ç‰‡é—´è· */
            padding: 0;
            position: relative;
        }

        /* === 3. å¡æ§½ (å›¾ç‰‡ç»å¯¹å±…ä¸­) === */
        .scan-slot {
            width: 85.6mm; height: 54mm; /* ç‰©ç†å°ºå¯¸ */
            max-width: 85%; aspect-ratio: 85.6/54; 
            border: 2px dashed #9ca3af; 
            background-color: #f8fafc; 
            border-radius: 8px; 
            position: relative; 
            overflow: hidden; 
            cursor: pointer; 
            display: flex; justify-content: center; align-items: center;
        }

        /* æ ¸å¿ƒï¼šå›¾ç‰‡å¼ºåˆ¶å±…ä¸­ï¼Œæ— è§†å®¹å™¨ Padding */
        .scan-slot img { 
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            width: 100%; height: 100%; 
            object-fit: fill; /* å¼ºåˆ¶å¡«æ»¡ï¼Œä¸ç•™ç™½è¾¹ */
            display: none; 
            z-index: 10;
        }

        .slot-placeholder { text-align: center; color: #94a3b8; pointer-events: none; z-index: 1; }
        .slot-placeholder h3 { font-size: 16px; margin-bottom: 5px; color: #475569; font-weight: 600; }
        .icon-cam { font-size: 24px; display: block; margin-bottom: 8px; }

        /* === 4. åº•éƒ¨æŒ‰é’® === */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05); 
            display: flex; gap: 15px; z-index: 100;
        }
        .btn { flex: 1; height: 50px; border-radius: 25px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-main { background: #2563eb; color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .btn-sec { background: #f1f5f9; color: #334155; }
        .btn:active { transform: scale(0.98); }

        /* === 5. ç›¸æœºé®ç½©å±‚ === */
        .camera-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; 
            display: none; 
        }

        /* æ¸²æŸ“ç”»å¸ƒ (æ›¿ä»£ Video æ ‡ç­¾æ˜¾ç¤º) */
        canvas#camera-canvas { display: block; width: 100%; height: 100%; }
        /* éšè—çš„ Video æº */
        #hidden-video { display: none; }

        /* UI æµ®å±‚ */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; 
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            padding: 50px 0; z-index: 20;
        }

        .top-tip {
            color: white; background: rgba(0,0,0,0.5); 
            padding: 8px 16px; border-radius: 20px; font-size: 14px;
            text-shadow: 0 1px 2px black;
        }

        .controls-area {
            width: 100%; pointer-events: auto;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }

        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’® (æ›´æ˜æ˜¾) */
        .mode-btn {
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.5);
            color: #4ade80; padding: 10px 24px; border-radius: 30px; 
            font-size: 15px; font-weight: 500; cursor: pointer; backdrop-filter: blur(4px);
            transition: all 0.3s;
        }

        .shutter-row { display: flex; width: 100%; justify-content: space-around; align-items: center; }
        
        .shutter-btn { 
            width: 76px; height: 76px; background: white; border-radius: 50%; 
            border: 5px solid rgba(220,220,220,0.6); cursor: pointer; 
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        .shutter-btn:active { transform: scale(0.9); background: #eee; }

        .circle-btn {
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(255,255,255,0.2); backdrop-filter: blur(4px);
            border: none; color: white; font-size: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
        }

        .generating .scan-slot { border: none; background: white; }
        .generating .slot-placeholder { display: none; }
    </style>
</head>
<body>

    <div class="paper-container" id="pdf-area">
        <div class="scan-slot" onclick="startCamera('front')">
            <div class="slot-placeholder" id="ph-front">
                <span class="icon-cam">ğŸ“·</span>
                <h3>æ‹æ‘„äººåƒé¢</h3><p>ç‚¹å‡»å¼€å¯ç›¸æœº</p>
            </div>
            <img id="img-front">
        </div>
        <div class="scan-slot" onclick="startCamera('back')">
            <div class="slot-placeholder" id="ph-back">
                <span class="icon-cam">ğŸ“·</span>
                <h3>æ‹æ‘„å›½å¾½é¢</h3><p>ç‚¹å‡»å¼€å¯ç›¸æœº</p>
            </div>
            <img id="img-back">
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn btn-sec" onclick="location.reload()">æ¸…ç©º</button>
        <button class="btn btn-main" onclick="makePDF()">ç”Ÿæˆ PDF</button>
    </div>

    <div class="camera-overlay" id="cam-modal">
        <video id="hidden-video" autoplay playsinline muted></video>
        <canvas id="camera-canvas"></canvas>

        <div class="ui-layer">
            <div class="top-tip">å°†è¯ä»¶å±…ä¸­æ”¾å…¥æ¡†å†…</div>
            
            <div class="controls-area">
                <button class="mode-btn" id="color-btn" onclick="toggleColor()">ğŸ¨ å½“å‰ï¼šå½©è‰²åŸå›¾</button>

                <div class="shutter-row">
                    <button class="circle-btn" onclick="closeCamera()">å–æ¶ˆ</button>
                    <button class="shutter-btn" onclick="takePhoto()"></button>
                    <button class="circle-btn" onclick="switchCamera()">åˆ‡æ¢</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 1. çŠ¶æ€ç®¡ç† ===
        let stream = null;
        let animationId = null;
        let currentSide = '';
        let isColor = true; // é»˜è®¤å½©è‰²ï¼Œä¿®å¤å®‰å“é—®é¢˜
        let devices = [];
        let devIdx = 0;

        const video = document.getElementById('hidden-video');
        const canvas = document.getElementById('camera-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const modal = document.getElementById('cam-modal');
        const colorBtn = document.getElementById('color-btn');

        // åˆ‡æ¢é¢œè‰²æ¨¡å¼
        function toggleColor() {
            isColor = !isColor;
            if (isColor) {
                colorBtn.innerText = "ğŸ¨ å½“å‰ï¼šå½©è‰²åŸå›¾";
                colorBtn.style.color = "#4ade80";
                colorBtn.style.borderColor = "rgba(74, 222, 128, 0.5)";
            } else {
                colorBtn.innerText = "ğŸ“„ å½“å‰ï¼šé»‘ç™½å¤å°";
                colorBtn.style.color = "white";
                colorBtn.style.borderColor = "rgba(255,255,255,0.5)";
            }
        }

        // === 2. å¯åŠ¨ç›¸æœº ===
        async function startCamera(side) {
            currentSide = side;
            modal.style.display = 'block';
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            try {
                // å¼ºåˆ¶è¯·æ±‚åç½®ç¯å¢ƒé•œå¤´ï¼Œé«˜æ¸…
                await startStream({ video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } });
            } catch (e) {
                // å…¼å®¹æ€§é™çº§
                await startStream({ video: true });
            }
            
            await listDevices();
            drawLoop(); // å¯åŠ¨ç”»é¢æ¸²æŸ“
        }

        async function startStream(constraints) {
            if (stream) stream.getTracks().forEach(t => t.stop());
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: false, ...constraints });
                video.srcObject = stream;
                await video.play();
            } catch (e) {
                alert("æ— æ³•å¯åŠ¨ç›¸æœº: " + e.message);
            }
        }

        async function listDevices() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return;
            const devs = await navigator.mediaDevices.enumerateDevices();
            devices = devs.filter(d => d.kind === 'videoinput');
        }

        async function switchCamera() {
            if (devices.length < 2) { await listDevices(); if(devices.length<2) return; }
            devIdx = (devIdx + 1) % devices.length;
            await startStream({ video: { deviceId: { exact: devices[devIdx].deviceId } } });
        }

        // === 3. æ ¸å¿ƒæ¸²æŸ“ (è§£å†³å¯¹é½å’Œåå·¦é—®é¢˜) ===
        function drawLoop() {
            if (modal.style.display === 'none') return;
            
            const cW = canvas.width;
            const cH = canvas.height;
            const vW = video.videoWidth;
            const vH = video.videoHeight;

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, cW, cH);

            // A. ç»˜åˆ¶è§†é¢‘åº•å›¾ (Center Crop æ¨¡å¼)
            if (vW && vH) {
                // è®¡ç®—å¡«å……æ¯”ä¾‹ï¼šè®©è§†é¢‘çŸ­è¾¹å¡«æ»¡å±å¹•
                const scale = Math.max(cW / vW, cH / vH);
                const drawW = vW * scale;
                const drawH = vH * scale;
                // è®¡ç®—å±…ä¸­åç§»é‡
                const offsetX = (cW - drawW) / 2;
                const offsetY = (cH - drawH) / 2;
                
                ctx.drawImage(video, offsetX, offsetY, drawW, drawH);
            }

            // B. ç»˜åˆ¶é®ç½©å’Œå–æ™¯æ¡†
            // å®šä¹‰å–æ™¯æ¡†å°ºå¯¸ï¼šå®½=å±å¹•85%ï¼Œæ¯”ä¾‹å›ºå®š
            const boxW = cW * 0.85; 
            const boxH = boxW / 1.585; 
            // ç»å¯¹å±…ä¸­ä½ç½®
            const boxX = (cW - boxW) / 2;
            const boxY = (cH - boxH) / 2; // æ”¾åœ¨æ­£ä¸­é—´ï¼Œä¸åä¸Šä¸åä¸‹

            // 1. ç”»åŠé€æ˜é»‘åº•
            ctx.fillStyle = "rgba(0, 0, 0, 0.85)";
            ctx.fillRect(0, 0, cW, cH);

            // 2. æŒ–ç©ºä¸­é—´ (é‡ç»˜è§†é¢‘)
            // å…ˆæ¸…é™¤é»‘åº•
            ctx.clearRect(boxX, boxY, boxW, boxH);
            
            // é‡æ–°åœ¨æŒ–ç©ºåŒºç”»ä¸€éè§†é¢‘ï¼Œä¿è¯ä¸­é—´æ˜¯äº®çš„
            ctx.save();
            ctx.beginPath();
            ctx.rect(boxX, boxY, boxW, boxH);
            ctx.clip();
            if (vW && vH) {
                const scale = Math.max
