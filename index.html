<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>èº«ä»½è¯å¤å°ä»¶ç”Ÿæˆå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            margin: 0; padding: 0; background: #000; color: #fff;
            font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* é¡¶éƒ¨æ  */
        .header {
            height: 44px; background: #111; z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; border-bottom: 1px solid #333;
        }
        .title { font-size: 14px; font-weight: bold; }
        .btn-switch {
            padding: 6px 12px; background: #333; border: 1px solid #555;
            border-radius: 4px; font-size: 12px; color: #eee;
        }

        /* ç›¸æœºè§†å£ */
        .viewport {
            position: relative; flex: 1; background: #000;
            overflow: hidden; /* å…³é”®ï¼šéšè—æº¢å‡º */
        }
        
        /* è§†é¢‘æµï¼šå¿…é¡»å¡«æ»¡å±å¹• */
        video { 
            width: 100%; height: 100%; 
            object-fit: cover; /* å…³é”®ï¼šè®©è§†é¢‘å……æ»¡å±å¹•ï¼Œä½†è¿™å¯¼è‡´äº†è£åˆ‡é—®é¢˜ */
        }

        /* ç»¿è‰²æ‰«ææ¡† (å±å¹•å±…ä¸­) */
        .guide-box {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%); /* ç»å¯¹å±…ä¸­ */
            width: 85%; /* å±å¹•å®½åº¦çš„ 85% */
            aspect-ratio: 1.58 / 1; /* èº«ä»½è¯æ¯”ä¾‹ */
            border: 2px solid #0f0; border-radius: 8px;
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.6); /* å‹æš—èƒŒæ™¯ */
            pointer-events: none; z-index: 5;
        }
        .guide-text {
            position: absolute; width: 100%; text-align: center;
            bottom: -30px; font-size: 14px; text-shadow: 0 1px 2px #000;
        }

        /* åº•éƒ¨å¿«é—¨ */
        .controls {
            height: 120px; background: #000; z-index: 10;
            display: flex; justify-content: center; align-items: center;
        }
        .shutter {
            width: 72px; height: 72px; border: 4px solid #fff; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
        }
        .shutter-inner { width: 60px; height: 60px; background: #fff; border-radius: 50%; }
        .shutter:active .shutter-inner { background: #ccc; transform: scale(0.9); }

        /* é¢„è§ˆå±‚ */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 100;
            display: none; flex-direction: column;
        }
        .modal-body { flex: 1; padding: 20px; text-align: center; overflow-y: auto; }
        .preview-img { 
            width: 60%; margin-bottom: 20px; border: 1px solid #444; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .modal-foot { padding: 20px; display: flex; gap: 15px; background: #222; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .btn-cancel { background: #333; color: #fff; }
        .btn-save { background: #0f0; color: #000; }

        /* é”™è¯¯æç¤º */
        #err-toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(200,0,0,0.9); padding: 15px; border-radius: 8px;
            text-align: center; display: none; z-index: 200; width: 80%; font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="title">é«˜æ¸…æ‰«æ (æ— æ°´å°ç‰ˆ)</div>
        <button class="btn-switch" onclick="switchCam()">ğŸ”„ åˆ‡æ¢é•œå¤´</button>
    </div>

    <div class="viewport" id="viewport">
        <video id="video" autoplay playsinline muted></video>
        <div class="guide-box" id="guide-box">
            <div class="guide-text" id="tip">è¯·å¯¹å‡† èº«ä»½è¯æ­£é¢</div>
        </div>
    </div>

    <div class="controls">
        <div class="shutter" onclick="takePhoto()">
            <div class="shutter-inner"></div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-body">
            <h3 style="margin-top:0">é¢„è§ˆæ•ˆæœ</h3>
            <p style="color:#aaa; font-size:12px">æ­£é¢</p>
            <img id="view-f" class="preview-img">
            <p style="color:#aaa; font-size:12px">åé¢</p>
            <img id="view-b" class="preview-img">
        </div>
        <div class="modal-foot">
            <button class="btn btn-cancel" onclick="location.reload()">é‡æ‹</button>
            <button class="btn btn-save" onclick="savePDF()">ä¸‹è½½æ— æ°´å° PDF</button>
        </div>
    </div>

    <div id="err-toast"></div>
    <canvas id="cvs" style="display:none"></canvas>

    <script>
        let step = 1; // 1=æ­£é¢, 2=åé¢
        let imgFront = null;
        let imgBack = null;
        let stream = null;
        
        // å…¼å®¹æ€§é…ç½®ï¼šå®‰å“é€šå¸¸éœ€è¦å¼ºåˆ¶åˆ†è¾¨ç‡æ‰èƒ½è°ƒèµ·ä¸»æ‘„
        const videoConfig = {
            audio: false,
            video: { 
                facingMode: 'environment',
                width: { ideal: 1920 }, // å¼ºåˆ¶é«˜æ¸…ï¼Œé˜²æ­¢å®‰å“è°ƒç”¨æ¨¡ç³Šé•œå¤´
                height: { ideal: 1080 } 
            }
        };

        const video = document.getElementById('video');
        const viewport = document.getElementById('viewport');
        const guideBox = document.getElementById('guide-box');
        const cvs = document.getElementById('cvs');
        const ctx = cvs.getContext('2d');

        // 1. å¯åŠ¨ç›¸æœº
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia(videoConfig);
                video.srcObject = stream;
            } catch (err) {
                console.warn("é«˜æ¸…å¯åŠ¨å¤±è´¥ï¼Œå°è¯•é™çº§", err);
                try {
                    // é™çº§ï¼šä¸é™åˆ¶åˆ†è¾¨ç‡
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    video.srcObject = stream;
                } catch (fatal) {
                    showError("ç›¸æœºå¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–å°è¯•ä½¿ç”¨ç³»ç»Ÿæµè§ˆå™¨ã€‚");
                }
            }
        }

        // 2. æ‹ç…§ä¸ã€ç²¾ç¡®è£åˆ‡ç®—æ³•ã€‘
        function takePhoto() {
            if (!video.srcObject) return;

            // A. è·å–è§†é¢‘æµçš„çœŸå®åŸå§‹å°ºå¯¸
            const vW = video.videoWidth;
            const vH = video.videoHeight;

            // B. è·å–å±å¹•è§†å£çš„æ˜¾ç¤ºå°ºå¯¸
            const viewW = viewport.offsetWidth;
            const viewH = viewport.offsetHeight;

            // C. è·å–ç»¿æ¡†åœ¨å±å¹•ä¸Šçš„ä½ç½®å’Œå°ºå¯¸
            const guideRect = guideBox.getBoundingClientRect();
            const viewRect = viewport.getBoundingClientRect();

            // è®¡ç®—ç»¿æ¡†ç›¸å¯¹äºè§†å£çš„åæ ‡ (px)
            const guideX = guideRect.left - viewRect.left;
            const guideY = guideRect.top - viewRect.top;
            const guideW = guideRect.width;
            const guideH = guideRect.height;

            // D. ã€æ ¸å¿ƒç®—æ³•ã€‘ï¼šè®¡ç®— object-fit: cover é€ æˆçš„ç¼©æ”¾æ¯”ä¾‹
            // video åœ¨ CSS é‡Œè¢«ç¼©æ”¾å¡«æ»¡äº†è§†å£ï¼Œæˆ‘ä»¬è¦ç®—å‡ºè¿™ä¸ªç¼©æ”¾æ¯”ä¾‹
            const scale = Math.max(viewW / vW, viewH / vH);

            // E. è®¡ç®—è§†å£ä¸­æ˜¾ç¤ºçš„è§†é¢‘åŒºåŸŸï¼Œåœ¨åŸå§‹è§†é¢‘ä¸­çš„ä½ç½®
            // è§†å£å®½ viewW å¯¹åº”åŸå§‹è§†é¢‘å®½ viewW / scale
            // è§†å£é«˜ viewH å¯¹åº”åŸå§‹è§†é¢‘é«˜ viewH / scale
            
            // è®¡ç®—ç”±äº object-fit å¯¼è‡´çš„åç§»é‡ (åŸå§‹è§†é¢‘ä¸­å¿ƒç‚¹ å¯¹é½ è§†å£ä¸­å¿ƒç‚¹)
            const videoDisplayW = vW * scale;
            const videoDisplayH = vH * scale;
            
            const offsetX = (videoDisplayW - viewW) / 2;
            const offsetY = (videoDisplayH - viewH) / 2;

            // F. æ˜ å°„ç»¿æ¡†åæ ‡åˆ°åŸå§‹è§†é¢‘åæ ‡
            // åŸå§‹X = (ç»¿æ¡†å±å¹•X + å·¦ä¾§è¢«è£æ‰çš„åç§») / ç¼©æ”¾æ¯”
            const sourceX = (guideX + offsetX) / scale;
            const sourceY = (guideY + offsetY) / scale;
            const sourceW = guideW / scale;
            const sourceH = guideH / scale;

            // G. ç»˜åˆ¶è£åˆ‡åçš„å›¾
            cvs.width = sourceW;
            cvs.height = sourceH;
            
            // drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh)
            ctx.drawImage(video, sourceX, sourceY, sourceW, sourceH, 0, 0, sourceW, sourceH);

            // è¾“å‡ºé«˜æ¸…å›¾ç‰‡
            const resultImg = cvs.toDataURL('image/jpeg', 0.95);

            if (step === 1) {
                imgFront = resultImg;
                step = 2;
                document.getElementById('tip').innerText = "è¯·å¯¹å‡† èº«ä»½è¯åé¢";
                flash();
            } else {
                imgBack = resultImg;
                showModal();
            }
        }

        function flash() {
            document.body.style.opacity = 0.5;
            setTimeout(() => document.body.style.opacity = 1, 100);
        }

        function showModal() {
            document.getElementById('view-f').src = imgFront;
            document.getElementById('view-b').src = imgBack;
            document.getElementById('modal').style.display = 'flex';
        }

        // 3. åˆ‡æ¢æ‘„åƒå¤´ (è§£å†³å®‰å“é€‰é”™é•œå¤´é—®é¢˜)
        async function switchCam() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            try {
                // ç®€å•åˆ‡æ¢ï¼šè¯·æ±‚ user æ¨¡å¼é€šå¸¸ä¼šåˆ‡æ¢å‰ç½®ï¼Œå†åˆ‡å› environment
                // ç”±äº Web é™åˆ¶ï¼Œå¾ˆéš¾ç²¾å‡†éå†ï¼Œè¿™é‡Œä½¿ç”¨é‡ç½®ç­–ç•¥
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch(e) {
                initCamera();
            }
        }

        // 4. ç”Ÿæˆæ— æ°´å° PDF
        function savePDF() {
            const { jsPDF } = window.jspdf;
            // A4 çº¸å¼ 
            const doc = new jsPDF({ unit: 'mm', format: 'a4' });

            const idW = 85.6; // èº«ä»½è¯æ ‡å‡†å®½
            const idH = 54;   // èº«ä»½è¯æ ‡å‡†é«˜
            const x = (210 - idW) / 2; // å±…ä¸­X

            // ã€å…³é”®ã€‘ï¼šè¿™é‡Œä¸å†æ·»åŠ ä»»ä½• doc.text æ–‡å­—ï¼Œåªæœ‰å›¾ç‰‡
            
            // æ­£é¢ (è·ç¦»é¡¶éƒ¨ 30mm)
            doc.addImage(imgFront, 'JPEG', x, 30, idW, idH);

            // åé¢ (è·ç¦»æ­£é¢ä¸‹æ–¹ 15mm)
            doc.addImage(imgBack, 'JPEG', x, 30 + idH + 15, idW, idH);

            doc.save('èº«ä»½è¯_å¤å°ä»¶.pdf');
        }

        function showError(msg) {
            const el = document.getElementById('err-toast');
            el.innerHTML = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // å¯åŠ¨
        initCamera();

    </script>
</body>
</html>
