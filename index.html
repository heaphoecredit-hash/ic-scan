<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>èº«ä»½è¯æ‰«æ (åŒä¿é™©ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            margin: 0; padding: 0; background: #000; color: #fff;
            font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* é¡¶éƒ¨æç¤º */
        .header {
            height: 44px; background: #111; z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; font-size: 14px; border-bottom: 1px solid #333;
        }
        .btn-switch {
            padding: 5px 12px; background: #333; border: 1px solid #555;
            border-radius: 4px; font-size: 12px; color: #fff;
        }

        /* ä¸»è§†å›¾åŒºåŸŸ */
        .viewport {
            position: relative; flex: 1; background: #000;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        
        /* 1. WebRTC è§†é¢‘æµ */
        video { width: 100%; height: 100%; object-fit: cover; }

        /* 2. å¤‡ç”¨æ–¹æ¡ˆï¼šæ–‡ä»¶ä¸Šä¼ éšå½¢æŒ‰é’® */
        .fallback-input {
            display: none; /* é»˜è®¤éšè—ï¼ŒWebRTCå¤±è´¥æ—¶æ‰å¯ç”¨ */
        }

        /* ç»¿æ¡†å¼•å¯¼ */
        .guide-box {
            position: absolute;
            width: 85%; aspect-ratio: 1.58 / 1;
            border: 2px solid #0f0; border-radius: 6px;
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.5);
            pointer-events: none; z-index: 5;
        }
        .guide-text {
            position: absolute; width: 100%; text-align: center;
            bottom: -35px; color: #fff; text-shadow: 0 1px 2px #000;
        }

        /* é”™è¯¯/å¤‡ç”¨ æç¤ºå±‚ */
        #error-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 20;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center;
        }
        .err-btn {
            margin-top: 20px; padding: 15px 30px;
            background: #007aff; color: #fff; font-size: 18px; font-weight: bold;
            border: none; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,122,255,0.4);
        }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls {
            height: 140px; background: #000; z-index: 10;
            display: flex; justify-content: center; align-items: center;
        }
        .shutter {
            width: 72px; height: 72px; border: 4px solid #fff; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
        }
        .shutter-in {
            width: 60px; height: 60px; background: #fff; border-radius: 50%;
        }
        .shutter:active .shutter-in { transform: scale(0.9); background: #ccc; }

        /* é¢„è§ˆå±‚ */
        .preview-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; z-index: 100;
            display: none; flex-direction: column;
        }
        .p-body { flex: 1; padding: 20px; overflow-y: auto; text-align: center; }
        .p-img { width: 70%; border: 1px solid #555; margin-bottom: 20px; }
        .p-foot { padding: 20px; display: flex; gap: 10px; background: #222; }
        .btn { flex: 1; padding: 15px; border-radius: 8px; border: none; font-weight: bold; font-size: 16px; }
        .btn-re { background: #444; color: #fff; }
        .btn-dl { background: #0f0; color: #000; }
    </style>
</head>
<body>

    <div class="header">
        <span id="status-text">æ­£åœ¨å¯åŠ¨ç›¸æœº...</span>
        <button class="btn-switch" onclick="switchCam()">ğŸ”„ åˆ‡æ¢é•œå¤´</button>
    </div>

    <div class="viewport">
        <video id="video" autoplay playsinline muted></video>
        
        <div class="guide-box">
            <div class="guide-text" id="guide-tip">è¯·å¯¹å‡† èº«ä»½è¯æ­£é¢</div>
        </div>

        <div id="error-layer">
            <h3 style="color:#ff4444">ç½‘é¡µç›¸æœºå¯åŠ¨å¤±è´¥</h3>
            <p style="color:#aaa; font-size:14px; margin-bottom:20px" id="err-detail">
                åŸå› æœªçŸ¥
            </p>
            <p style="font-size:14px">è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦ç›¸æœºæ‹æ‘„ï¼š</p>
            
            <button class="err-btn" onclick="triggerSysCam()">ğŸ“· è°ƒç”¨ç³»ç»Ÿç›¸æœº</button>
        </div>
    </div>

    <div class="controls">
        <div class="shutter" onclick="captureWebCam()">
            <div class="shutter-in"></div>
        </div>
    </div>

    <input type="file" id="sys-cam-input" class="fallback-input" accept="image/*" capture="environment" onchange="handleSysFile(this)">

    <div class="preview-modal" id="modal">
        <div class="p-body">
            <h3>é¢„è§ˆç¡®è®¤</h3>
            <p style="color:#aaa">æ­£é¢</p>
            <img id="view-f" class="p-img">
            <p style="color:#aaa">åé¢</p>
            <img id="view-b" class="p-img">
        </div>
        <div class="p-foot">
            <button class="btn btn-re" onclick="location.reload()">é‡æ‹</button>
            <button class="btn btn-dl" onclick="savePDF()">ä¸‹è½½ PDF</button>
        </div>
    </div>

    <canvas id="cvs" style="display:none"></canvas>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---
        let step = 1; // 1=æ­£é¢, 2=åé¢
        let imgFront = null;
        let imgBack = null;
        let stream = null;
        let useSystemCam = false; // æ ‡è®°æ˜¯å¦è¢«è¿«ä½¿ç”¨äº†ç³»ç»Ÿç›¸æœº

        const video = document.getElementById('video');
        const cvs = document.getElementById('cvs');
        const ctx = cvs.getContext('2d');
        const errLayer = document.getElementById('error-layer');
        const statusText = document.getElementById('status-text');

        // 1. åˆå§‹åŒ–ï¼šå°è¯•å¯åŠ¨ç½‘é¡µç›¸æœº
        async function initWebCam() {
            // HTTPS æ£€æŸ¥
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                showFallback("å¿…é¡»ä½¿ç”¨ HTTPS åè®®æ‰èƒ½è°ƒç”¨ç›¸æœºã€‚<br>è¯·ç›´æ¥ä½¿ç”¨ä¸‹æ–¹ç³»ç»Ÿç›¸æœºã€‚");
                return;
            }

            try {
                // æç®€å¯åŠ¨ï¼šå…ˆä¸æŒ‘è‚¥æ‹£ç˜¦ï¼Œèƒ½å¼€å°±è¡Œï¼Œè§£å†³å®‰å“æ‰“ä¸å¼€çš„é—®é¢˜
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = stream;
                statusText.innerText = "ç›¸æœºå·²å°±ç»ª (å½©è‰²)";
            } catch (err) {
                console.warn("åç½®å¤±è´¥ï¼Œå°è¯•é€šç”¨æ¨¡å¼", err);
                try {
                    // é™çº§å°è¯•
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    statusText.innerText = "ç›¸æœºå·²å°±ç»ª (å…¼å®¹æ¨¡å¼)";
                } catch (fatal) {
                    // å½»åº•å¤±è´¥ï¼Œæ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ
                    showFallback("æ— æ³•è®¿é—®æ‘„åƒå¤´ (æƒé™è¢«æ‹’æˆ–ä¸æ”¯æŒ)ã€‚<br>è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ã€‚");
                }
            }
        }

        // æ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆå±‚
        function showFallback(msg) {
            useSystemCam = true;
            video.style.display = 'none'; // éšè—é»‘å±çš„video
            errLayer.style.display = 'flex';
            document.getElementById('err-detail').innerHTML = msg;
            statusText.innerText = "åˆ‡æ¢è‡³ç³»ç»Ÿç›¸æœºæ¨¡å¼";
            // éšè—åº•éƒ¨çš„æ‹ç…§åœ†åœˆï¼Œé¿å…æ··æ·†
            document.querySelector('.controls').style.display = 'none';
        }

        // 2. ç½‘é¡µç›¸æœºï¼šæ‹ç…§
        function captureWebCam() {
            if (!video.srcObject) return;
            
            // ç»˜åˆ¶
            cvs.width = video.videoWidth;
            cvs.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            processAndNext(cvs);
        }

        // 3. ç³»ç»Ÿç›¸æœºï¼šè§¦å‘ä¸å¤„ç†
        function triggerSysCam() {
            document.getElementById('sys-cam-input').click();
        }

        function handleSysFile(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        cvs.width = img.width;
                        cvs.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        processAndNext(cvs);
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
            // æ¸…ç©ºinputé˜²æ­¢é‡å¤è§¦å‘å¤±æ•ˆ
            input.value = ''; 
        }

        // 4. é€šç”¨å¤„ç†ï¼šè£åˆ‡ -> ä¸‹ä¸€æ­¥
        function processAndNext(sourceCanvas) {
            // æ™ºèƒ½è£åˆ‡ (åªå–ä¸­é—´ 80%)
            const finalImg = smartCrop(sourceCanvas);

            if (step === 1) {
                imgFront = finalImg;
                step = 2;
                document.getElementById('guide-tip').innerText = "è¯·å¯¹å‡† èº«ä»½è¯åé¢";
                alert("æ­£é¢å·²ä¿å­˜ï¼\nè¯·ç»§ç»­æ‹æ‘„ã€åé¢ã€‘");
                
                // å¦‚æœæ˜¯ç³»ç»Ÿç›¸æœºæ¨¡å¼ï¼Œè‡ªåŠ¨å†è°ƒèµ·ä¸€æ¬¡
                if (useSystemCam) {
                    setTimeout(() => triggerSysCam(), 500); 
                }
            } else {
                imgBack = finalImg;
                showPreview();
            }
        }

        // 5. æ™ºèƒ½è£åˆ‡ç®—æ³• (å½©è‰²)
        function smartCrop(c) {
            const w = c.width, h = c.height;
            const ratio = 1.58; 
            const scale = 0.8; // è£åˆ‡ç³»æ•°
            
            let cw, ch, cx, cy;
            if (w/h > ratio) { ch = h*scale; cw = ch*ratio; }
            else { cw = w*scale; ch = cw/ratio; }
            
            cx = (w-cw)/2; cy = (h-ch)/2;

            const t = document.createElement('canvas');
            t.width = cw; t.height = ch;
            t.getContext('2d').drawImage(c, cx, cy, cw, ch, 0, 0, cw, ch);
            return t.toDataURL('image/jpeg', 0.95);
        }

        function showPreview() {
            document.getElementById('view-f').src = imgFront;
            document.getElementById('view-b').src = imgBack;
            document.getElementById('modal').style.display = 'flex';
        }

        // 6. åˆ‡æ¢é•œå¤´ (ç½‘é¡µç›¸æœºæ¨¡å¼ä¸“ç”¨)
        async function switchCam() {
            if (useSystemCam) {
                alert("ç³»ç»Ÿç›¸æœºæ¨¡å¼ä¸‹ï¼Œè¯·åœ¨æ‹ç…§ç•Œé¢å†…åˆ‡æ¢é•œå¤´ã€‚");
                return;
            }
            // ç®€å•ç²—æš´ï¼šåœæ­¢å½“å‰ï¼Œé‡æ–°è¯·æ±‚ userï¼ˆé€šå¸¸ä¼šåˆ‡æ¢åˆ°å‰ç½®ï¼Œå†åˆ‡å›åç½®ï¼‰
            // æ³¨æ„ï¼šWebæ ‡å‡†åˆ‡æ¢é•œå¤´å¾ˆéº»çƒ¦ï¼Œè¿™é‡Œåªåšç®€å•çš„é‡ç½®å°è¯•
            if(stream) stream.getTracks().forEach(t=>t.stop());
            initWebCam(); 
        }

        // 7. ç”Ÿæˆ PDF
        function savePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'mm', format: 'a4' });
            const w = 85.6; const h = 54; const x = (210-w)/2;

            doc.setFontSize(14);
            doc.text("ID Card Scan (Color)", 105, 15, {align:'center'});
            
            doc.setFontSize(10);
            doc.text("Front:", x, 30);
            doc.addImage(imgFront, 'JPEG', x, 35, w, h);
            
            doc.text("Back:", x, 35+h+15);
            doc.addImage(imgBack, 'JPEG', x, 35+h+20, w, h);
            
            doc.save('èº«ä»½è¯_æ‰«æä»¶.pdf');
        }

        // å¯åŠ¨
        initWebCam();

    </script>
</body>
</html>
