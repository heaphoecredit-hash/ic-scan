<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>IC 正反面一页（安卓后摄/直接保存PDF）</title>

  <!-- jsPDF (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b0b0f; --card:#12121a; --line:#232336; --txt:#fff; --muted:#a8a8b8;
      --accent:#00d084;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:900px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .head{padding:12px 14px;border-bottom:1px solid var(--line)}
    .title{font-weight:800}
    .sub{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4}
    .controls{padding:12px 14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{
      appearance:none;border:0;border-radius:12px;padding:12px 14px;
      background:#0d3b2f;color:#eafff8;font-weight:800;cursor:pointer
    }
    button[disabled]{opacity:.45;cursor:not-allowed}
    .ghost{background:transparent;border:1px solid var(--line);color:var(--txt);font-weight:700}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px 14px 16px}
    @media (max-width:700px){.grid{grid-template-columns:1fr}}
    .slot{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#0a0a0f}
    .slot .cap{padding:10px 12px;border-bottom:1px solid var(--line);color:var(--muted);font-size:12px}
    .slot img{width:100%;height:240px;object-fit:contain;display:block;background:#000}
    .hint{padding:0 14px 14px;color:var(--muted);font-size:12px;line-height:1.5}
    input[type=file]{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="title">IC 正反面一页（安卓后摄 / 直接保存PDF）</div>
        <div class="sub">
          建议用安卓 Chrome 打开（HTTPS）。点击按钮会调用系统相机后摄拍照；会自动裁切成“只剩证件”（无边框）。
        </div>
      </div>

      <div class="controls">
        <button id="frontBtn">拍 IC 正面（后摄）</button>
        <button id="backBtn">拍 IC 反面（后摄）</button>
        <button id="savePdfBtn" disabled>保存PDF（A4竖）</button>
        <button id="clearBtn" class="ghost">清除重拍</button>
      </div>

      <div class="grid">
        <div class="slot">
          <div class="cap">正面（已自动裁成证件比例）</div>
          <img id="frontImg" alt="front">
        </div>
        <div class="slot">
          <div class="cap">反面（已自动裁成证件比例）</div>
          <img id="backImg" alt="back">
        </div>
      </div>

      <div class="hint">
        如果你是在微信/FB/IG 内置浏览器打开，可能会无法调用相机。请复制网址到 Chrome 打开。
      </div>
    </div>
  </div>

  <!-- System camera capture (rear) -->
  <input id="frontInput" type="file" accept="image/*" capture="environment">
  <input id="backInput"  type="file" accept="image/*" capture="environment">

<script>
(() => {
  const frontBtn = document.getElementById('frontBtn');
  const backBtn  = document.getElementById('backBtn');
  const clearBtn = document.getElementById('clearBtn');
  const savePdfBtn = document.getElementById('savePdfBtn');

  const frontInput = document.getElementById('frontInput');
  const backInput  = document.getElementById('backInput');

  const frontImg = document.getElementById('frontImg');
  const backImg  = document.getElementById('backImg');

  let frontDataUrl = '';
  let backDataUrl  = '';

  // 防抖（避免连点）
  let locked = false;
  const lock = () => { locked = true; setTimeout(()=>locked=false, 600); };

  // 证件比例（MyKad / IC 约 85.6×54mm => 1.585）
  const CARD_RATIO = 85.6 / 54;

  function updateState(){
    savePdfBtn.disabled = !(frontDataUrl && backDataUrl);
  }

  function fileToImage(file){
    return new Promise((resolve, reject) => {
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
      img.onerror = reject;
      img.src = url;
    });
  }

  // 自动裁切：从照片中心裁出“证件比例”区域（去掉多余背景/边框）
  function cropToCard(img){
    const sw = img.naturalWidth;
    const sh = img.naturalHeight;

    // 目标裁切框：尽量大，保持 CARD_RATIO
    let cw = sw;
    let ch = Math.round(cw / CARD_RATIO);
    if(ch > sh){
      ch = sh;
      cw = Math.round(ch * CARD_RATIO);
    }

    // 中心裁切
    const sx = Math.round((sw - cw) / 2);
    const sy = Math.round((sh - ch) / 2);

    const canvas = document.createElement('canvas');
    canvas.width = cw;
    canvas.height = ch;
    const ctx = canvas.getContext('2d');

    ctx.drawImage(img, sx, sy, cw, ch, 0, 0, cw, ch);

    // 输出 JPEG
    return canvas.toDataURL('image/jpeg', 0.92);
  }

  async function handlePick(inputEl, side){
    const file = inputEl.files && inputEl.files[0];
    inputEl.value = '';
    if(!file) return;

    const img = await fileToImage(file);
    const cropped = cropToCard(img);

    if(side === 'front'){
      frontDataUrl = cropped;
      frontImg.src = cropped;
    } else {
      backDataUrl = cropped;
      backImg.src = cropped;
    }
    updateState();
  }

  frontBtn.onclick = () => { if(locked) return; lock(); frontInput.click(); };
  backBtn.onclick  = () => { if(locked) return; lock(); backInput.click(); };

  frontInput.addEventListener('change', () => handlePick(frontInput, 'front'));
  backInput.addEventListener('change',  () => handlePick(backInput, 'back'));

  clearBtn.onclick = () => {
    frontDataUrl = ''; backDataUrl = '';
    frontImg.removeAttribute('src');
    backImg.removeAttribute('src');
    updateState();
  };

  savePdfBtn.onclick = async () => {
    if(!frontDataUrl || !backDataUrl) return;

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });

    // A4: 210×297mm，留边
    const margin = 10;
    const pageW = 210, pageH = 297;
    const innerW = pageW - margin*2;

    // 两列布局
    const gap = 8;
    const colW = (innerW - gap) / 2;

    // 证件图按比例放入（contain）
    const cardW = colW;
    const cardH = cardW / CARD_RATIO;

    const y = 25; // 顶部留白
    const x1 = margin;
    const x2 = margin + colW + gap;

    // 标题可去掉（你要“完全无字”我再给你一版）
    pdf.setFontSize(12);
    pdf.text('IC (Front / Back)', margin, 15);

    pdf.addImage(frontDataUrl, 'JPEG', x1, y, cardW, cardH);
    pdf.addImage(backDataUrl,  'JPEG', x2, y, cardW, cardH);

    pdf.save('IC_front_back_A4.pdf');
  };

  updateState();
})();
</script>
</body>
</html>
