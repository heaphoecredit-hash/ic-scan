<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>完美居中证件复印</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }
        body { 
            background: #e5e5e5; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            /* 让A4纸在手机屏幕上也尽量纵向居中 */
            justify-content: center;
            min-height: 100vh; 
            padding-bottom: 90px; /* 留出底部按钮空间 */
        }

        /* === A4 纸张容器 (核心修改) === */
        .paper-container {
            background: white;
            width: 95vw;
            max-width: 500px;
            aspect-ratio: 210/297; /* 锁定 A4 比例 */
            
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            
            /* === 布局核心 CSS === */
            display: flex;
            flex-direction: column; /* 确保一上一下排列 */
            /* 关键：垂直方向居中 */
            justify-content: center;
            /* 关键：水平方向居中 */
            align-items: center;
            /* 正反面之间的间距 */
            gap: 50px; 
            /* 移除内边距，完全靠 flex 居中 */
            padding: 0;
        }

        /* 卡槽位样式 */
        .scan-slot {
            width: 85.6mm; /* 身份证物理宽度 */
            height: 54mm;  /* 身份证物理高度 */
            max-width: 90%; /* 防止窄屏手机溢出 */
            aspect-ratio: 85.6/54; 
            
            border: 2px dashed #ccc;
            background-color: #f9f9f9;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .scan-slot img {
            width: 100%;
            height: 100%;
            object-fit: fill;
            display: none;
        }

        .slot-placeholder {
            text-align: center; color: #999; pointer-events: none;
        }
        .slot-placeholder h3 { font-size: 16px; margin-bottom: 5px; color: #666; }
        .slot-placeholder p { font-size: 12px; }

        /* === 底部操作栏 === */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: flex; gap: 15px; z-index: 50;
        }
        .btn { flex: 1; height: 50px; border-radius: 25px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-main { background: #2563eb; color: white; }
        .btn-sec { background: #f1f5f9; color: #333; }

        /* === 相机遮罩界面 === */
        .camera-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 999;
            display: none; justify-content: center; align-items: center;
        }

        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }

        .mask-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

        .guide-text {
            position: absolute; top: 8%; width: 100%; text-align: center; color: white; 
            font-size: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 20;
        }
        .guide-text b { color: #00ff00; }

        /* 滤镜开关 */
        .filter-switch {
            position: absolute; top: 15%; z-index: 30;
            background: rgba(0,0,0,0.6); padding: 8px 15px;
            border-radius: 20px; color: white; font-size: 13px;
            display: flex; align-items: center; gap: 8px;
        }

        /* 拍照按钮区 */
        .cam-actions {
            position: absolute; bottom: 40px; width: 100%;
            display: flex; justify-content: space-around; align-items: center; z-index: 20;
        }
        .shutter-btn {
            width: 72px; height: 72px; background: white; border-radius: 50%;
            border: 5px solid rgba(220,220,220,0.5); cursor: pointer;
        }
        .shutter-btn:active { transform: scale(0.92); background: #eee; }
        .close-btn { color: white; background: rgba(0,0,0,0.3); border: none; font-size: 14px; padding: 10px 15px; border-radius: 20px; backdrop-filter: blur(5px);}

        /* 生成中状态 */
        .generating .scan-slot { border: none; background: white; }
        .generating .slot-placeholder { display: none; }
    </style>
</head>
<body>

    <div class="paper-container" id="pdf-area">
        <div class="scan-slot" onclick="startScan('front')">
            <div class="slot-placeholder" id="ph-front">
                <h3>+ 身份证人像面</h3>
                <p>点击拍摄 (自动复印效果)</p>
            </div>
            <img id="img-front">
        </div>

        <div class="scan-slot" onclick="startScan('back')">
            <div class="slot-placeholder" id="ph-back">
                <h3>+ 身份证国徽面</h3>
                <p>点击拍摄 (自动复印效果)</p>
            </div>
            <img id="img-back">
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn btn-sec" onclick="location.reload()">重置</button>
        <button class="btn btn-main" onclick="makePDF()">生成 PDF</button>
    </div>

    <div class="camera-overlay" id="cam-modal">
        <video id="video" autoplay playsinline muted></video>
        <svg class="mask-svg" width="100%" height="100%">
            <defs>
                <mask id="mask-layer">
                    <rect x="0" y="0" width="100%" height="100%" fill="white" />
                    <rect id="cutout-rect" fill="black" rx="8" ry="8" />
                </mask>
            </defs>
            <rect x="0" y="0" width="100%" height="100%" fill="rgba(0,0,0,0.88)" mask="url(#mask-layer)" />
            <rect id="border-rect" fill="transparent" stroke="#00ff00" stroke-width="2" rx="8" ry="8" />
        </svg>
        <div class="guide-text">请移动手机，让证件<b>完全填满</b>绿框</div>
        <label class="filter-switch"><input type="checkbox" id="bw-mode" checked> 复印模式</label>
        <div class="cam-actions">
            <button class="close-btn" onclick="closeCam()">取消</button>
            <button class="shutter-btn" onclick="takePhoto()"></button>
            <button class="close-btn" onclick="switchCam()">换镜头</button>
        </div>
    </div>

    <script>
        // === JavaScript 代码与上一版保持一致，保证扫描效果 ===
        let currentStream = null; let currentSide = ''; let videoDevices = []; let devIndex = 0;
        const video = document.getElementById('video'); const modal = document.getElementById('cam-modal');
        const cutout = document.getElementById('cutout-rect'); const border = document.getElementById('border-rect');

        async function initDev() {
            if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                const devs = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devs.filter(d => d.kind === 'videoinput');
                const back = videoDevices.findIndex(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('environment'));
                if(back !== -1) devIndex = back;
            }
        }
        initDev();

        function adjustMask() {
            const sW = window.innerWidth; const sH = window.innerHeight;
            const bW = sW * 0.88; const bH = bW / 1.585;
            const x = (sW - bW) / 2; const y = (sH - bH) / 2 - 40;
            cutout.setAttribute('x', x); cutout.setAttribute('y', y); cutout.setAttribute('width', bW); cutout.setAttribute('height', bH);
            border.setAttribute('x', x); border.setAttribute('y', y); border.setAttribute('width', bW); border.setAttribute('height', bH);
            return { x, y, w: bW, h: bH };
        }

        async function startScan(side) {
            currentSide = side; adjustMask(); modal.style.display = 'flex';
            const constraints = { audio: false, video: { deviceId: videoDevices.length ? { exact: videoDevices[devIndex].deviceId } : undefined, facingMode: videoDevices.length ? undefined : 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } };
            try { currentStream = await navigator.mediaDevices.getUserMedia(constraints); video.srcObject = currentStream; } catch(e) { alert("相机启动失败"); }
        }

        function closeCam() { modal.style.display = 'none'; if(currentStream) { currentStream.getTracks().forEach(t => t.stop()); currentStream = null; } }
        function switchCam() { if(videoDevices.length > 1) { devIndex = (devIndex + 1) % videoDevices.length; startScan(currentSide); } }

        function takePhoto() {
            if(!currentStream) return;
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            const vW = video.videoWidth; const vH = video.videoHeight;
            const sW = window.innerWidth; const sH = window.innerHeight;
            const vR = vW / vH; const sR = sW / sH;
            let rW, rH;
            if (sR > vR) { rW = sW; rH = sW / vR; } else { rH = sH; rW = sH * vR; }
            const mask = adjustMask();
            const oX = (rW - sW) / 2; const oY = (rH - sH) / 2;
            const scale = vW / rW;
            canvas.width = 1000; canvas.height = 1000 / 1.585;
            ctx.drawImage(video, (mask.x + oX) * scale, (mask.y + oY) * scale, mask.w * scale, mask.h * scale, 0, 0, canvas.width, canvas.height);

            if(document.getElementById('bw-mode').checked) {
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height); const data = imgData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const gray = (data[i] > 130 && data[i+1] > 130 && data[i+2] > 130) ? 255 : (0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]) * 0.7;
                    data[i] = data[i + 1] = data[i + 2] = gray;
                }
                ctx.putImageData(imgData, 0, 0);
            }
            const img = document.getElementById('img-' + currentSide); const ph = document.getElementById('ph-' + currentSide);
            img.src = canvas.toDataURL('image/jpeg', 0.9); img.style.display = 'block'; ph.style.display = 'none';
            closeCam();
        }

        function makePDF() {
            const el = document.getElementById('pdf-area');
            if(!document.getElementById('img-front').src && !document.getElementById('img-back').src) { alert("请先拍摄"); return; }
            el.classList.add('generating');
            html2pdf().set({ margin: 0, filename: '身份证复印件.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(el).save().then(() => { el.classList.remove('generating'); });
        }
        window.onresize = adjustMask;
    </script>
</body>
</html>
