<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>证件复印 (修复后置相机)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }
        body { 
            background: #e5e5e5; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            min-height: 100vh; 
            padding-bottom: 90px;
        }

        /* === A4 纸张容器 === */
        .paper-container {
            background: white;
            width: 95vw;
            max-width: 500px;
            aspect-ratio: 210/297; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column; 
            justify-content: center;
            align-items: center;
            gap: 50px; 
            padding: 0;
        }

        /* 卡槽位样式 */
        .scan-slot {
            width: 85.6mm;
            height: 54mm;
            max-width: 90%;
            aspect-ratio: 85.6/54; 
            border: 2px dashed #ccc;
            background-color: #f9f9f9;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .scan-slot img { width: 100%; height: 100%; object-fit: fill; display: none; }
        .slot-placeholder { text-align: center; color: #999; pointer-events: none; }
        .slot-placeholder h3 { font-size: 16px; margin-bottom: 5px; color: #666; }
        .slot-placeholder p { font-size: 12px; }

        /* === 底部操作栏 === */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: flex; gap: 15px; z-index: 50;
        }
        .btn { flex: 1; height: 50px; border-radius: 25px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-main { background: #2563eb; color: white; }
        .btn-sec { background: #f1f5f9; color: #333; }

        /* === 相机遮罩界面 === */
        .camera-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 999;
            display: none; justify-content: center; align-items: center;
        }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .mask-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .guide-text { position: absolute; top: 8%; width: 100%; text-align: center; color: white; font-size: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 20; }
        .guide-text b { color: #00ff00; }
        
        .filter-switch {
            position: absolute; top: 15%; z-index: 30;
            background: rgba(0,0,0,0.6); padding: 8px 15px;
            border-radius: 20px; color: white; font-size: 13px;
            display: flex; align-items: center; gap: 8px;
        }
        
        .cam-actions {
            position: absolute; bottom: 40px; width: 100%;
            display: flex; justify-content: space-around; align-items: center; z-index: 20;
        }
        .shutter-btn { width: 72px; height: 72px; background: white; border-radius: 50%; border: 5px solid rgba(220,220,220,0.5); cursor: pointer; }
        .shutter-btn:active { transform: scale(0.92); background: #eee; }
        .close-btn { color: white; background: rgba(0,0,0,0.3); border: none; font-size: 14px; padding: 10px 15px; border-radius: 20px; backdrop-filter: blur(5px);}
        
        /* 错误提示 */
        #error-log { position: fixed; top: 0; left: 0; width: 100%; background: red; color: white; font-size: 12px; padding: 5px; display: none; z-index: 9999; }

        .generating .scan-slot { border: none; background: white; }
        .generating .slot-placeholder { display: none; }
    </style>
</head>
<body>
    <div id="error-log"></div>

    <div class="paper-container" id="pdf-area">
        <div class="scan-slot" onclick="startScan('front')">
            <div class="slot-placeholder" id="ph-front">
                <h3>+ 身份证人像面</h3>
                <p>点击拍摄 (自动复印效果)</p>
            </div>
            <img id="img-front">
        </div>
        <div class="scan-slot" onclick="startScan('back')">
            <div class="slot-placeholder" id="ph-back">
                <h3>+ 身份证国徽面</h3>
                <p>点击拍摄 (自动复印效果)</p>
            </div>
            <img id="img-back">
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn btn-sec" onclick="location.reload()">重置</button>
        <button class="btn btn-main" onclick="makePDF()">生成 PDF</button>
    </div>

    <div class="camera-overlay" id="cam-modal">
        <video id="video" autoplay playsinline muted></video>
        <svg class="mask-svg" width="100%" height="100%">
            <defs>
                <mask id="mask-layer">
                    <rect x="0" y="0" width="100%" height="100%" fill="white" />
                    <rect id="cutout-rect" fill="black" rx="8" ry="8" />
                </mask>
            </defs>
            <rect x="0" y="0" width="100%" height="100%" fill="rgba(0,0,0,0.88)" mask="url(#mask-layer)" />
            <rect id="border-rect" fill="transparent" stroke="#00ff00" stroke-width="2" rx="8" ry="8" />
        </svg>
        <div class="guide-text">请移动手机，让证件<b>完全填满</b>绿框</div>
        <label class="filter-switch"><input type="checkbox" id="bw-mode" checked> 复印模式</label>
        <div class="cam-actions">
            <button class="close-btn" onclick="closeCam()">取消</button>
            <button class="shutter-btn" onclick="takePhoto()"></button>
            <button class="close-btn" onclick="switchCam()">切换前后</button>
        </div>
    </div>

    <script>
        let currentStream = null; 
        let currentSide = ''; 
        let useBackCamera = true; // 默认：强制使用后置
        
        const video = document.getElementById('video'); 
        const modal = document.getElementById('cam-modal');
        const cutout = document.getElementById('cutout-rect'); 
        const border = document.getElementById('border-rect');
        const errLog = document.getElementById('error-log');

        function adjustMask() {
            const sW = window.innerWidth; const sH = window.innerHeight;
            const bW = sW * 0.88; const bH = bW / 1.585;
            const x = (sW - bW) / 2; const y = (sH - bH) / 2 - 40;
            cutout.setAttribute('x', x); cutout.setAttribute('y', y); cutout.setAttribute('width', bW); cutout.setAttribute('height', bH);
            border.setAttribute('x', x); border.setAttribute('y', y); border.setAttribute('width', bW); border.setAttribute('height', bH);
            return { x, y, w: bW, h: bH };
        }

        async function startScan(side) {
            currentSide = side; 
            adjustMask(); 
            modal.style.display = 'flex';
            errLog.style.display = 'none';

            // 停止之前的流
            if (currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
            }

            // 核心修复：更强制的后置摄像头请求逻辑
            const constraints = { 
                audio: false, 
                video: { 
                    // 尝试请求 "exact: environment" (后置)，如果不行则由浏览器决定
                    facingMode: useBackCamera ? { exact: "environment" } : "user",
                    width: { ideal: 1920 }, 
                    height: { ideal: 1080 } 
                } 
            };

            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
            } catch(e) {
                console.warn("Exact facingMode failed, retrying loose mode...", e);
                // 降级重试：如果 exact: environment 失败（比如在PC上或部分安卓机），尝试宽松模式
                try {
                    const looseConstraints = { 
                        video: { 
                            facingMode: useBackCamera ? "environment" : "user",
                        } 
                    };
                    currentStream = await navigator.mediaDevices.getUserMedia(looseConstraints);
                    video.srcObject = currentStream;
                } catch (err2) {
                    console.error(err2);
                    errLog.innerText = "相机启动失败: " + err2.message;
                    errLog.style.display = 'block';
                }
            }
        }

        function closeCam() { 
            modal.style.display = 'none'; 
            if(currentStream) { 
                currentStream.getTracks().forEach(t => t.stop()); 
                currentStream = null; 
            } 
        }

        // 简化的切换逻辑：只是改变 boolean 值，然后重启相机
        function switchCam() { 
            useBackCamera = !useBackCamera; // 切换状态
            startScan(currentSide); // 重启相机应用新状态
        }

        function takePhoto() {
            if(!currentStream) return;
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            const vW = video.videoWidth; const vH = video.videoHeight;
            const sW = window.innerWidth; const sH = window.innerHeight;
            const vR = vW / vH; const sR = sW / sH;
            let rW, rH;
            if (sR > vR) { rW = sW; rH = sW / vR; } else { rH = sH; rW = sH * vR; }
            const mask = adjustMask();
            const oX = (rW - sW) / 2; const oY = (rH - sH) / 2;
            const scale = vW / rW;
            canvas.width = 1000; canvas.height = 1000 / 1.585;
            ctx.drawImage(video, (mask.x + oX) * scale, (mask.y + oY) * scale, mask.w * scale, mask.h * scale, 0, 0, canvas.width, canvas.height);

            if(document.getElementById('bw-mode').checked) {
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height); const data = imgData.data;
                for (let i = 0; i < data.length; i += 4) {
                    // 更强的去底算法：只要不是特别黑，都变白
                    const r = data[i]; const g = data[i+1]; const b = data[i+2];
                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    // 阈值设为 120，高于这个亮度的变纯白，低于的变深灰
                    const final = gray > 120 ? 255 : gray * 0.6;
                    data[i] = data[i + 1] = data[i + 2] = final;
                }
                ctx.putImageData(imgData, 0, 0);
            }
            const img = document.getElementById('img-' + currentSide); const ph = document.getElementById('ph-' + currentSide);
            img.src = canvas.toDataURL('image/jpeg', 0.9); img.style.display = 'block'; ph.style.display = 'none';
            closeCam();
        }

        function makePDF() {
            const el = document.getElementById('pdf-area');
            if(!document.getElementById('img-front').src && !document.getElementById('img-back').src) { alert("请先拍摄"); return; }
            el.classList.add('generating');
            html2pdf().set({ margin: 0, filename: '身份证复印件.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(el).save().then(() => { el.classList.remove('generating'); });
        }
        window.onresize = adjustMask;
    </script>
</body>
</html>
